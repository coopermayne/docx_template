<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RFP Response Tool</title>
    <link rel="stylesheet" href="/static/css/main.css">
    <script defer src="/static/vendor/alpine.min.js"></script>
    <script src="/static/js/api.js"></script>
</head>
<body>
    <div x-data="app()" x-init="init()">
        <!-- Header -->
        <header>
            <div class="container" style="display: flex; justify-content: space-between; align-items: center;">
                <h1 style="margin: 0;">Legal RFP Response Tool</h1>
                <nav class="header-nav">
                    <button class="nav-btn" :class="{ 'active': currentPage === 'rfp' }" @click="switchPage('rfp')">
                        RFP Tool
                    </button>
                    <button class="nav-btn" :class="{ 'active': currentPage === 'motion_opposition' }" @click="switchPage('motion_opposition')">
                        Motion Opposition
                    </button>
                    <div class="user-selector" style="margin-left: 1rem; position: relative;">
                        <button class="nav-btn" @click="showUserDropdown = !showUserDropdown" style="display: flex; align-items: center; gap: 0.5rem;">
                            <span x-text="currentUser ? currentUser.icon : 'üë§'" style="font-size: 1.2rem;"></span>
                            <span x-text="currentUser ? currentUser.name : 'Sign In'"></span>
                            <span style="font-size: 0.7rem;">‚ñº</span>
                        </button>
                        <div x-show="showUserDropdown" @click.away="showUserDropdown = false"
                             class="user-dropdown" style="position: absolute; right: 0; top: 100%; background: white; border: 1px solid var(--gray-300); border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); min-width: 220px; z-index: 100; margin-top: 0.5rem;">
                            <div class="dropdown-menu">
                                <template x-for="user in users" :key="user.id">
                                    <a href="#" @click.prevent="selectUser(user)"
                                       class="dropdown-item"
                                       :class="{ 'active': currentUser?.id === user.id }">
                                        <span x-text="user.icon"></span>
                                        <span x-text="user.name.split(' ')[0]"></span>
                                    </a>
                                </template>
                                <div x-show="users.length === 0" class="dropdown-item" style="color: var(--gray-500);">
                                    No users yet
                                </div>
                                <div class="dropdown-divider"></div>
                                <a href="#" @click.prevent="switchPage('users'); showUserDropdown = false" class="dropdown-item">
                                    <span x-text="users.length === 0 ? '+ Add User' : 'Manage Users'"></span>
                                </a>
                                <a href="#" x-show="currentUser" @click.prevent="signOut()" class="dropdown-item">
                                    Sign Out
                                </a>
                            </div>
                        </div>
                    </div>
                </nav>
            </div>
        </header>

        <main class="container">
            <!-- RFP Tool Page -->
            <div x-show="currentPage === 'rfp'">
            <!-- Steps Indicator -->
            <ul class="steps">
                <li class="step"
                    :class="{ 'active': currentStep === 1, 'completed': currentStep > 1 }"
                    @click="goToStep(1)">
                    <span class="step-number">1</span>
                    <span class="step-label">Upload RFP</span>
                </li>
                <li class="step"
                    :class="{ 'active': currentStep === 2, 'completed': currentStep > 2 }"
                    @click="session.id && goToStep(2)">
                    <span class="step-number">2</span>
                    <span class="step-label">Add Documents</span>
                </li>
                <li class="step"
                    :class="{ 'active': currentStep === 3, 'completed': currentStep > 3 }"
                    @click="session.requests.length && goToStep(3)">
                    <span class="step-number">3</span>
                    <span class="step-label">Review & Edit</span>
                </li>
                <li class="step"
                    :class="{ 'active': currentStep === 4 }"
                    @click="session.analysis_complete && goToStep(4)">
                    <span class="step-number">4</span>
                    <span class="step-label">Generate</span>
                </li>
            </ul>

            <!-- RFP Toolbar -->
            <div style="display: flex; justify-content: flex-end; margin-bottom: 1rem;">
                <button class="btn btn-secondary" style="font-size: 0.875rem;" @click="switchPage('objections')">
                    Manage Objections
                </button>
            </div>

            <!-- Error Alert -->
            <div x-show="error" class="alert alert-error" x-text="error"></div>

            <!-- Step 1: Upload RFP -->
            <div x-show="currentStep === 1" class="card">
                <h2 class="card-title">Upload Request for Production (RFP)</h2>

                <div class="upload-zone"
                     :class="{ 'dragover': isDragging }"
                     @dragover.prevent="isDragging = true"
                     @dragleave.prevent="isDragging = false"
                     @drop.prevent="handleRFPDrop($event)"
                     @click="$refs.rfpInput.click()">
                    <div class="upload-zone-icon">üìÑ</div>
                    <div class="upload-zone-text">
                        <template x-if="!uploading">
                            <span>Drag & drop your RFP PDF here, or click to browse</span>
                        </template>
                        <template x-if="uploading">
                            <span class="loading">
                                <span class="spinner"></span>
                                Parsing PDF...
                            </span>
                        </template>
                    </div>
                    <div class="upload-zone-hint">PDF files only</div>
                </div>
                <input type="file"
                       x-ref="rfpInput"
                       accept=".pdf"
                       style="display: none"
                       @change="handleRFPSelect($event)">

                <!-- Parsed Requests Preview - Editable -->
                <template x-if="session.requests.length > 0">
                    <div style="margin-top: 1.5rem;">
                        <h3 class="card-title">Parsed Requests (<span x-text="session.requests.length"></span> found)</h3>
                        <p style="color: var(--gray-600); margin-bottom: 1rem; font-size: 0.875rem;">
                            Review and edit the parsed requests below. Fix any parsing errors before continuing.
                        </p>
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th style="width: 80px;">Request #</th>
                                    <th>Request Text</th>
                                    <th style="width: 80px;">Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                <template x-for="(request, index) in session.requests" :key="request.id">
                                    <tr>
                                        <td>
                                            <input type="text"
                                                   x-model="request.number"
                                                   class="table-input"
                                                   style="width: 60px; text-align: center;"
                                                   @blur="updateRequest(request)">
                                        </td>
                                        <td>
                                            <textarea x-model="request.text"
                                                      class="table-input"
                                                      rows="3"
                                                      style="width: 100%;"
                                                      @blur="updateRequest(request)"></textarea>
                                        </td>
                                        <td style="text-align: center;">
                                            <button class="btn-icon" @click="removeRequest(index)" title="Remove request">‚úï</button>
                                        </td>
                                    </tr>
                                </template>
                            </tbody>
                        </table>

                        <div class="actions-bar">
                            <button class="btn btn-secondary" @click="addRequest()">+ Add Request</button>
                            <button class="btn btn-primary" @click="saveRequestsAndContinue()">
                                Save & Continue ‚Üí
                            </button>
                        </div>
                    </div>
                </template>
            </div>

            <!-- Step 2: Add Documents -->
            <div x-show="currentStep === 2" class="card">
                <h2 class="card-title">Add Responsive Documents</h2>
                <p style="color: var(--gray-600); margin-bottom: 1rem;">
                    Drag and drop your document files. We'll extract file names and Bates numbers automatically.
                </p>

                <div class="upload-zone"
                     :class="{ 'dragover': isDragging }"
                     @dragover.prevent="isDragging = true"
                     @dragleave.prevent="isDragging = false"
                     @drop.prevent="handleDocsDrop($event)"
                     @click="$refs.docsInput.click()">
                    <div class="upload-zone-icon">üìÅ</div>
                    <div class="upload-zone-text">Drag & drop documents here, or click to browse</div>
                    <div class="upload-zone-hint">We'll extract metadata from the files</div>
                </div>
                <input type="file"
                       x-ref="docsInput"
                       multiple
                       style="display: none"
                       @change="handleDocsSelect($event)">

                <!-- Document List - Table Format -->
                <template x-if="session.documents.length > 0">
                    <div style="margin-top: 1.5rem;">
                        <h3 class="card-title">Documents (<span x-text="session.documents.length"></span>)</h3>
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Filename</th>
                                    <th style="width: 120px;">Bates Start</th>
                                    <th style="width: 120px;">Bates End</th>
                                    <th style="width: 200px;">Description</th>
                                    <th style="width: 60px;">Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                <template x-for="doc in session.documents" :key="doc.id">
                                    <tr>
                                        <td>
                                            <input type="text"
                                                   x-model="doc.filename"
                                                   class="table-input"
                                                   style="width: 100%;"
                                                   @blur="updateDocMeta(doc)">
                                        </td>
                                        <td>
                                            <input type="text"
                                                   x-model="doc.bates_start"
                                                   class="table-input"
                                                   placeholder="e.g., ABC001"
                                                   @blur="updateDocMeta(doc)">
                                        </td>
                                        <td>
                                            <input type="text"
                                                   x-model="doc.bates_end"
                                                   class="table-input"
                                                   placeholder="e.g., ABC050"
                                                   @blur="updateDocMeta(doc)">
                                        </td>
                                        <td>
                                            <input type="text"
                                                   x-model="doc.description"
                                                   class="table-input"
                                                   placeholder="Brief description"
                                                   @blur="updateDocMeta(doc)">
                                        </td>
                                        <td style="text-align: center;">
                                            <button class="btn-icon" @click="removeDocument(doc.id)" title="Remove">‚úï</button>
                                        </td>
                                    </tr>
                                </template>
                            </tbody>
                        </table>
                    </div>
                </template>

                <div class="actions-bar">
                    <button class="btn btn-secondary" @click="goToStep(1)">‚Üê Back</button>
                    <button class="btn btn-primary" @click="runAnalysis()" :disabled="analyzing">
                        <template x-if="!analyzing">
                            <span>Analyze with AI ‚Üí</span>
                        </template>
                        <template x-if="analyzing">
                            <span class="loading" style="padding: 0;">
                                <span class="spinner"></span>
                                Analyzing...
                            </span>
                        </template>
                    </button>
                </div>
            </div>

            <!-- Step 3: Review & Edit -->
            <div x-show="currentStep === 3" class="card">
                <h2 class="card-title">Review AI Suggestions</h2>
                <p style="color: var(--gray-600); margin-bottom: 1rem;">
                    Review and edit the suggested objections and responsive documents for each request.
                </p>

                <div class="review-grid">
                    <template x-for="request in session.requests" :key="request.id">
                        <div class="review-request">
                            <div class="review-request-header">
                                <div class="request-header">
                                    <span class="request-number">Request #<span x-text="request.number"></span></span>
                                    <label style="margin-left: auto; display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                                        <input type="checkbox" x-model="request.include_in_response">
                                        Include in response
                                    </label>
                                </div>
                                <div class="request-text" x-text="request.text"></div>
                            </div>
                            <div class="review-request-body">
                                <!-- Objections -->
                                <div class="review-section">
                                    <div class="review-section-title">Objections</div>
                                    <div class="checkbox-grid">
                                        <template x-for="obj in objections" :key="obj.id">
                                            <label class="checkbox-item"
                                                   :class="{ 'selected': request.selected_objections.includes(obj.id) }"
                                                   :title="request.objection_reasoning && request.objection_reasoning[obj.id] ? request.objection_reasoning[obj.id] : ''"
                                                   @click="toggleObjection(request, obj.id)">
                                                <span x-text="obj.short_name"></span>
                                            </label>
                                        </template>
                                    </div>
                                </div>

                                <!-- Responsive Documents -->
                                <div class="review-section">
                                    <div class="review-section-title">Responsive Documents</div>
                                    <div class="multi-select">
                                        <template x-for="doc in session.documents" :key="doc.id">
                                            <label class="multi-select-item"
                                                   :class="{ 'selected': request.selected_documents.includes(doc.id) }"
                                                   @click="toggleDocument(request, doc.id)">
                                                <span x-text="doc.filename"></span>
                                            </label>
                                        </template>
                                    </div>
                                    <div x-show="session.documents.length === 0" style="color: var(--gray-500); font-size: 0.875rem;">
                                        No documents added
                                    </div>
                                </div>

                                <!-- AI Notes -->
                                <div class="review-section" x-show="request.ai_notes">
                                    <div class="review-section-title">AI Notes</div>
                                    <div class="ai-notes" x-text="request.ai_notes"></div>
                                </div>

                                <!-- User Notes -->
                                <div class="review-section">
                                    <div class="review-section-title">Your Notes</div>
                                    <textarea
                                        class="document-description"
                                        placeholder="Add your notes..."
                                        rows="2"
                                        x-model="request.user_notes"
                                        style="width: 100%;"></textarea>
                                </div>
                            </div>
                        </div>
                    </template>
                </div>

                <div class="actions-bar">
                    <button class="btn btn-secondary" @click="goToStep(2)">‚Üê Back</button>
                    <button class="btn btn-primary" @click="saveAndContinue()">
                        Save & Continue ‚Üí
                    </button>
                </div>
            </div>

            <!-- Step 4: Generate -->
            <div x-show="currentStep === 4" class="card">
                <h2 class="card-title">Generate Response Document</h2>

                <div class="alert alert-info">
                    Ready to generate your RFP response document with:
                    <ul style="margin-top: 0.5rem; margin-left: 1.5rem;">
                        <li><span x-text="session.requests.filter(r => r.include_in_response).length"></span> requests included</li>
                        <li><span x-text="session.documents.length"></span> responsive documents referenced</li>
                    </ul>
                </div>

                <div style="text-align: center; padding: 2rem; display: flex; gap: 1rem; justify-content: center; flex-wrap: wrap;">
                    <button class="btn btn-success" style="font-size: 1rem; padding: 1rem 2rem;"
                            @click="generateDocument(false)" :disabled="generating">
                        <template x-if="!generating">
                            <span>üìÑ Generate Document</span>
                        </template>
                        <template x-if="generating">
                            <span class="loading" style="padding: 0;">
                                <span class="spinner"></span>
                                Generating...
                            </span>
                        </template>
                    </button>
                    <button class="btn btn-primary" style="font-size: 1rem; padding: 1rem 2rem;"
                            @click="generateDocument(true)" :disabled="generating">
                        <template x-if="!generating">
                            <span>üìÑ Generate with Reasoning</span>
                        </template>
                        <template x-if="generating">
                            <span class="loading" style="padding: 0;">
                                <span class="spinner"></span>
                                Generating...
                            </span>
                        </template>
                    </button>
                </div>

                <div class="actions-bar">
                    <button class="btn btn-secondary" @click="goToStep(3)">‚Üê Back to Review</button>
                    <button class="btn btn-secondary" @click="startOver()">Start New Session</button>
                </div>
            </div>
            </div><!-- End RFP Tool Page -->

            <!-- Motion Opposition Page -->
            <div x-show="currentPage === 'motion_opposition'">
                <div class="card">
                    <h2 class="card-title">Motion Opposition Generator</h2>
                    <p style="color: var(--gray-600); margin-bottom: 1.5rem;">
                        Upload a motion to extract case information and begin drafting your opposition papers.
                    </p>

                    <!-- Error Alert -->
                    <div x-show="motionError" class="alert alert-error" x-text="motionError"></div>

                    <!-- Upload Zone -->
                    <div class="upload-zone"
                         :class="{ 'dragover': motionDragging }"
                         @dragover.prevent="motionDragging = true"
                         @dragleave.prevent="motionDragging = false"
                         @drop.prevent="handleMotionDrop($event)"
                         @click="$refs.motionInput.click()">
                        <div class="upload-zone-icon">üìÑ</div>
                        <div class="upload-zone-text">
                            <template x-if="!motionUploading">
                                <span>Drag & drop your motion PDF here, or click to browse</span>
                            </template>
                            <template x-if="motionUploading">
                                <span class="loading">
                                    <span class="spinner"></span>
                                    Analyzing motion...
                                </span>
                            </template>
                        </div>
                        <div class="upload-zone-hint">PDF files only</div>
                    </div>
                    <input type="file"
                           x-ref="motionInput"
                           accept=".pdf"
                           style="display: none"
                           @change="handleMotionSelect($event)">

                    <!-- Motion Info Result -->
                    <template x-if="motionInfo">
                        <div style="margin-top: 1.5rem;">
                            <h3 class="card-title">Extracted Motion Information</h3>
                            <p style="color: var(--gray-600); margin-bottom: 1rem; font-size: 0.875rem;">
                                Filename: <span x-text="motionFilename"></span>
                            </p>
                            <pre style="background: var(--gray-100); border: 1px solid var(--gray-300); border-radius: 8px; padding: 1rem; overflow-x: auto; font-size: 0.875rem; line-height: 1.5;" x-text="JSON.stringify(motionInfo, null, 2)"></pre>
                            <div class="actions-bar" style="margin-top: 1rem;">
                                <button class="btn btn-secondary" @click="clearMotion()">Upload Another Motion</button>
                            </div>
                        </div>
                    </template>
                </div>
            </div><!-- End Motion Opposition Page -->

            <!-- Manage Objections Page -->
            <div x-show="currentPage === 'objections'">
                <div class="card">
                    <a href="#" @click.prevent="switchPage('rfp')" style="display: inline-flex; align-items: center; gap: 0.25rem; color: var(--gray-500); text-decoration: none; font-size: 0.875rem; margin-bottom: 1rem;">
                        ‚Üê Back to RFP Tool
                    </a>
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                        <h2 class="card-title" style="margin: 0;">Manage Objections</h2>
                        <button class="btn btn-primary" @click="showAddObjection = true">+ Add Objection</button>
                    </div>

                    <p style="color: var(--gray-600); margin-bottom: 1.5rem;">
                        Configure the objections available when responding to RFP requests. Changes apply to all future sessions.
                    </p>

                    <!-- Error Alert -->
                    <div x-show="objectionError" class="alert alert-error" x-text="objectionError"></div>

                    <!-- Objections List -->
                    <div class="objections-list">
                        <template x-for="(obj, index) in managedObjections" :key="obj.id">
                            <div class="objection-item">
                                <div class="objection-item-header">
                                    <div class="objection-item-title">
                                        <span class="objection-badge" x-text="obj.short_name"></span>
                                        <strong x-text="obj.name"></strong>
                                    </div>
                                    <div class="objection-item-actions">
                                        <button class="btn btn-sm btn-secondary" @click="editObjection(obj)">Edit</button>
                                    </div>
                                </div>
                                <div class="objection-item-body">
                                    <div class="objection-field">
                                        <label>Formal Language:</label>
                                        <p x-text="obj.formal_language"></p>
                                    </div>
                                    <div class="objection-field" x-show="obj.argument_template">
                                        <label>Argument Template:</label>
                                        <p x-text="obj.argument_template"></p>
                                    </div>
                                </div>
                            </div>
                        </template>
                    </div>

                    <div x-show="managedObjections.length === 0" style="text-align: center; padding: 2rem; color: var(--gray-500);">
                        No objections configured. Click "Add Objection" to create one.
                    </div>
                </div>
            </div><!-- End Manage Objections Page -->

            <!-- Manage Users Page -->
            <div x-show="currentPage === 'users'">
                <div class="card">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                        <h2 class="card-title" style="margin: 0;">Manage Users</h2>
                        <button class="btn btn-primary" @click="showAddUser = true">+ Add User</button>
                    </div>

                    <p style="color: var(--gray-600); margin-bottom: 1.5rem;">
                        Configure attorney users who can sign in and generate documents.
                    </p>

                    <!-- Error Alert -->
                    <div x-show="userError" class="alert alert-error" x-text="userError"></div>

                    <!-- Users List -->
                    <div class="objections-list">
                        <template x-for="user in managedUsers" :key="user.id">
                            <div class="objection-item">
                                <div class="objection-item-header">
                                    <div class="objection-item-title" style="display: flex; align-items: center; gap: 0.75rem;">
                                        <span x-text="user.icon" style="font-size: 1.5rem;"></span>
                                        <div>
                                            <strong x-text="user.name"></strong>
                                            <div style="font-size: 0.875rem; color: var(--gray-500);">
                                                Bar #<span x-text="user.bar_number"></span>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="objection-item-actions">
                                        <button class="btn btn-sm btn-secondary" @click="editUser(user)">Edit</button>
                                    </div>
                                </div>
                                <div class="objection-item-body">
                                    <div class="objection-field">
                                        <label>Email:</label>
                                        <p x-text="user.email"></p>
                                    </div>
                                </div>
                            </div>
                        </template>
                    </div>

                    <div x-show="managedUsers.length === 0" style="text-align: center; padding: 2rem; color: var(--gray-500);">
                        No users configured. Click "Add User" to create one.
                    </div>
                </div>
            </div><!-- End Manage Users Page -->

            <!-- Add/Edit User Modal -->
            <div x-show="showAddUser || editingUser" class="modal-overlay" @click.self="closeUserModal()">
                <div class="modal">
                    <div class="modal-header">
                        <h3 x-text="editingUser ? 'Edit User' : 'Add New User'"></h3>
                        <button class="btn-icon" @click="closeUserModal()">&times;</button>
                    </div>
                    <div class="modal-body">
                        <div class="form-group">
                            <label>Name</label>
                            <input type="text" x-model="userForm.name"
                                   placeholder="e.g., John Smith"
                                   class="form-input">
                        </div>
                        <div class="form-group">
                            <label>Bar Number</label>
                            <input type="text" x-model="userForm.bar_number"
                                   placeholder="e.g., 123456"
                                   class="form-input">
                        </div>
                        <div class="form-group">
                            <label>Email</label>
                            <input type="email" x-model="userForm.email"
                                   placeholder="e.g., john@lawfirm.com"
                                   class="form-input">
                        </div>
                        <div class="form-group">
                            <label>Icon</label>
                            <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                                <template x-for="icon in userIcons" :key="icon">
                                    <button type="button"
                                            @click="userForm.icon = icon"
                                            style="padding: 0.5rem; font-size: 1.5rem; border: 2px solid; border-radius: 8px; cursor: pointer; background: white;"
                                            :style="userForm.icon === icon ? 'border-color: var(--primary); background: var(--primary-light);' : 'border-color: var(--gray-300);'"
                                            x-text="icon"></button>
                                </template>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button x-show="editingUser" class="btn btn-danger" style="margin-right: auto;" @click="confirmDeleteUser(editingUser)">Delete</button>
                        <button class="btn btn-secondary" @click="closeUserModal()">Cancel</button>
                        <button class="btn btn-primary" @click="saveUser()" :disabled="savingUser">
                            <span x-show="!savingUser" x-text="editingUser ? 'Save Changes' : 'Add User'"></span>
                            <span x-show="savingUser" class="loading"><span class="spinner"></span> Saving...</span>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Delete User Confirmation Modal -->
            <div x-show="deletingUser" class="modal-overlay" @click.self="deletingUser = null">
                <div class="modal" style="max-width: 400px;">
                    <div class="modal-header">
                        <h3>Delete User</h3>
                        <button class="btn-icon" @click="deletingUser = null">&times;</button>
                    </div>
                    <div class="modal-body">
                        <p>Are you sure you want to delete "<strong x-text="deletingUser?.name"></strong>"?</p>
                        <p style="color: var(--gray-600); font-size: 0.875rem; margin-top: 0.5rem;">This action cannot be undone.</p>
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-secondary" @click="deletingUser = null">Cancel</button>
                        <button class="btn btn-danger" @click="deleteUser()">Delete</button>
                    </div>
                </div>
            </div>

            <!-- Add/Edit Objection Modal -->
            <div x-show="showAddObjection || editingObjection" class="modal-overlay" @click.self="closeObjectionModal()">
                <div class="modal">
                    <div class="modal-header">
                        <h3 x-text="editingObjection ? 'Edit Objection' : 'Add New Objection'"></h3>
                        <button class="btn-icon" @click="closeObjectionModal()">&times;</button>
                    </div>
                    <div class="modal-body">
                        <div class="form-group">
                            <label>Name</label>
                            <input type="text" x-model="objectionForm.name"
                                   placeholder="e.g., Vague and Ambiguous"
                                   class="form-input">
                        </div>
                        <div class="form-group">
                            <label>Short Name (for UI display)</label>
                            <input type="text" x-model="objectionForm.short_name"
                                   placeholder="e.g., Vague"
                                   class="form-input">
                        </div>
                        <div class="form-group">
                            <label>Formal Language</label>
                            <textarea x-model="objectionForm.formal_language" rows="3"
                                      placeholder="The formal objection text used in the response document..."
                                      class="form-input"></textarea>
                        </div>
                        <div class="form-group">
                            <label>Argument Template (optional)</label>
                            <textarea x-model="objectionForm.argument_template" rows="3"
                                      placeholder="A template argument supporting this objection..."
                                      class="form-input"></textarea>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button x-show="editingObjection" class="btn btn-danger" style="margin-right: auto;" @click="confirmDeleteObjection(editingObjection)">Delete</button>
                        <button class="btn btn-secondary" @click="closeObjectionModal()">Cancel</button>
                        <button class="btn btn-primary" @click="saveObjection()" :disabled="savingObjection">
                            <span x-show="!savingObjection" x-text="editingObjection ? 'Save Changes' : 'Add Objection'"></span>
                            <span x-show="savingObjection" class="loading"><span class="spinner"></span> Saving...</span>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Delete Confirmation Modal -->
            <div x-show="deletingObjection" class="modal-overlay" @click.self="deletingObjection = null">
                <div class="modal" style="max-width: 400px;">
                    <div class="modal-header">
                        <h3>Delete Objection</h3>
                        <button class="btn-icon" @click="deletingObjection = null">&times;</button>
                    </div>
                    <div class="modal-body">
                        <p>Are you sure you want to delete "<strong x-text="deletingObjection?.name"></strong>"?</p>
                        <p style="color: var(--gray-600); font-size: 0.875rem; margin-top: 0.5rem;">This action cannot be undone.</p>
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-secondary" @click="deletingObjection = null">Cancel</button>
                        <button class="btn btn-danger" @click="deleteObjection()">Delete</button>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        function app() {
            return {
                // Page navigation
                currentPage: 'rfp',

                // RFP Tool state
                currentStep: 1,
                isDragging: false,
                uploading: false,
                analyzing: false,
                generating: false,
                error: null,

                session: {
                    id: null,
                    requests: [],
                    documents: [],
                    analysis_complete: false
                },

                objections: [],

                // Motion Opposition state
                motionDragging: false,
                motionUploading: false,
                motionError: null,
                motionInfo: null,
                motionFilename: null,

                // Objections Management state
                managedObjections: [],
                objectionError: null,
                showAddObjection: false,
                editingObjection: null,
                deletingObjection: null,
                savingObjection: false,
                objectionForm: {
                    name: '',
                    short_name: '',
                    formal_language: '',
                    argument_template: ''
                },

                // Users state
                users: [],
                currentUser: null,
                showUserDropdown: false,
                managedUsers: [],
                userError: null,
                showAddUser: false,
                editingUser: null,
                deletingUser: null,
                savingUser: false,
                userIcons: ['üë§', 'üë®‚Äçüíº', 'üë©‚Äçüíº', 'üë®‚Äç‚öñÔ∏è', 'üë©‚Äç‚öñÔ∏è', 'üßë‚Äçüíº', '‚öñÔ∏è', 'üìã'],
                userForm: {
                    name: '',
                    bar_number: '',
                    email: '',
                    icon: 'üë§'
                },

                async init() {
                    // Load objection presets
                    try {
                        const data = await API.getObjections();
                        this.objections = data.objections || [];
                    } catch (e) {
                        console.error('Failed to load objections:', e);
                        this.objections = [];
                    }

                    // Load users
                    try {
                        const data = await API.getUsers();
                        this.users = data.users || [];
                        // Restore current user from localStorage
                        const savedUserId = localStorage.getItem('currentUserId');
                        if (savedUserId) {
                            this.currentUser = this.users.find(u => u.id == savedUserId) || null;
                        }
                    } catch (e) {
                        console.error('Failed to load users:', e);
                        this.users = [];
                    }
                },

                goToStep(step) {
                    this.error = null;
                    this.currentStep = step;
                },

                async handleRFPDrop(event) {
                    this.isDragging = false;
                    const files = event.dataTransfer.files;
                    if (files.length > 0) {
                        const file = files[0];
                        const isPdf = file.type === 'application/pdf' ||
                                      file.name.toLowerCase().endsWith('.pdf');
                        if (isPdf) {
                            await this.uploadRFP(file);
                        } else {
                            this.error = 'Please upload a PDF file';
                        }
                    }
                },

                async handleRFPSelect(event) {
                    const files = event.target.files;
                    if (files.length > 0) {
                        await this.uploadRFP(files[0]);
                    }
                },

                async uploadRFP(file) {
                    this.uploading = true;
                    this.error = null;

                    try {
                        const data = await API.uploadRFP(file, this.session.id);
                        this.session.id = data.session_id;
                        this.session.requests = data.requests.map(r => ({
                            ...r,
                            selected_objections: r.suggested_objections || [],
                            selected_documents: r.suggested_documents || [],
                            objection_reasoning: r.objection_reasoning || {}
                        }));
                    } catch (e) {
                        this.error = e.message;
                    } finally {
                        this.uploading = false;
                    }
                },

                async handleDocsDrop(event) {
                    this.isDragging = false;
                    const files = Array.from(event.dataTransfer.files);
                    await this.uploadDocuments(files);
                },

                async handleDocsSelect(event) {
                    const files = Array.from(event.target.files);
                    await this.uploadDocuments(files);
                },

                async uploadDocuments(files) {
                    this.error = null;

                    try {
                        const data = await API.uploadDocuments(this.session.id, files);
                        this.session.documents = [...this.session.documents, ...data.documents];
                    } catch (e) {
                        this.error = e.message;
                    }
                },

                async updateDocMeta(doc) {
                    try {
                        await API.updateDocument(this.session.id, doc.id, {
                            filename: doc.filename,
                            bates_start: doc.bates_start,
                            bates_end: doc.bates_end,
                            description: doc.description
                        });
                    } catch (e) {
                        console.error('Failed to update document:', e);
                    }
                },

                async updateRequest(request) {
                    try {
                        await API.updateRequest(this.session.id, request.id, {
                            number: request.number,
                            text: request.text
                        });
                    } catch (e) {
                        console.error('Failed to update request:', e);
                    }
                },

                removeRequest(index) {
                    this.session.requests.splice(index, 1);
                },

                addRequest() {
                    const maxId = Math.max(0, ...this.session.requests.map(r => r.id));
                    const maxNum = Math.max(0, ...this.session.requests.map(r => parseInt(r.number) || 0));
                    this.session.requests.push({
                        id: maxId + 1,
                        number: String(maxNum + 1),
                        text: '',
                        raw_text: '',
                        suggested_objections: [],
                        suggested_documents: [],
                        selected_objections: [],
                        selected_documents: [],
                        objection_reasoning: {},
                        ai_notes: '',
                        user_notes: '',
                        include_in_response: true
                    });
                },

                async saveRequestsAndContinue() {
                    this.error = null;
                    try {
                        // Save all requests via bulk update
                        const updates = {};
                        this.session.requests.forEach(r => {
                            updates[r.id] = {
                                number: r.number,
                                text: r.text
                            };
                        });
                        await API.bulkUpdateRequests(this.session.id, updates);
                        this.goToStep(2);
                    } catch (e) {
                        this.error = e.message;
                    }
                },

                async removeDocument(docId) {
                    try {
                        await API.deleteDocument(this.session.id, docId);
                        this.session.documents = this.session.documents.filter(d => d.id !== docId);
                        // Remove from selected_documents in all requests
                        this.session.requests.forEach(r => {
                            r.selected_documents = r.selected_documents.filter(id => id !== docId);
                        });
                    } catch (e) {
                        this.error = e.message;
                    }
                },

                async runAnalysis() {
                    this.analyzing = true;
                    this.error = null;

                    try {
                        const data = await API.runAnalysis(this.session.id);

                        // Update requests with suggestions
                        if (data.suggestions) {
                            this.session.requests.forEach(r => {
                                const suggestion = data.suggestions[r.number] || data.suggestions[r.id];
                                if (suggestion) {
                                    r.suggested_objections = suggestion.objections || [];
                                    r.suggested_documents = suggestion.documents || [];
                                    r.objection_reasoning = suggestion.objection_reasoning || {};
                                    r.ai_notes = suggestion.notes || '';
                                    // Pre-fill selections with suggestions
                                    r.selected_objections = [...r.suggested_objections];
                                    r.selected_documents = [...r.suggested_documents];
                                }
                            });
                        }

                        this.session.analysis_complete = true;
                        this.goToStep(3);
                    } catch (e) {
                        this.error = e.message;
                        // Still go to step 3 even if analysis fails
                        this.goToStep(3);
                    } finally {
                        this.analyzing = false;
                    }
                },

                toggleObjection(request, objId) {
                    const idx = request.selected_objections.indexOf(objId);
                    if (idx >= 0) {
                        request.selected_objections.splice(idx, 1);
                    } else {
                        request.selected_objections.push(objId);
                    }
                },

                toggleDocument(request, docId) {
                    const idx = request.selected_documents.indexOf(docId);
                    if (idx >= 0) {
                        request.selected_documents.splice(idx, 1);
                    } else {
                        request.selected_documents.push(docId);
                    }
                },

                async saveAndContinue() {
                    this.error = null;

                    try {
                        const updates = {};
                        this.session.requests.forEach(r => {
                            updates[r.id] = {
                                selected_objections: r.selected_objections,
                                selected_documents: r.selected_documents,
                                user_notes: r.user_notes,
                                include_in_response: r.include_in_response
                            };
                        });

                        await API.bulkUpdateRequests(this.session.id, updates);
                        this.goToStep(4);
                    } catch (e) {
                        this.error = e.message;
                    }
                },

                async generateDocument(includeReasoning = false) {
                    this.generating = true;
                    this.error = null;

                    try {
                        const { blob, filename } = await API.generateResponse(this.session.id, includeReasoning);

                        // Download the file
                        const url = window.URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = filename;
                        document.body.appendChild(a);
                        a.click();
                        document.body.removeChild(a);
                        window.URL.revokeObjectURL(url);
                    } catch (e) {
                        this.error = e.message;
                    } finally {
                        this.generating = false;
                    }
                },

                startOver() {
                    this.session = {
                        id: null,
                        requests: [],
                        documents: [],
                        analysis_complete: false
                    };
                    this.currentStep = 1;
                    this.error = null;
                },

                // Motion Opposition methods
                async handleMotionDrop(event) {
                    this.motionDragging = false;
                    const files = event.dataTransfer.files;
                    if (files.length > 0) {
                        const file = files[0];
                        const isPdf = file.type === 'application/pdf' ||
                                      file.name.toLowerCase().endsWith('.pdf');
                        if (isPdf) {
                            await this.uploadMotion(file);
                        } else {
                            this.motionError = 'Please upload a PDF file';
                        }
                    }
                },

                async handleMotionSelect(event) {
                    const files = event.target.files;
                    if (files.length > 0) {
                        await this.uploadMotion(files[0]);
                    }
                    // Reset the input so the same file can be selected again
                    event.target.value = '';
                },

                async uploadMotion(file) {
                    this.motionUploading = true;
                    this.motionError = null;
                    this.motionInfo = null;
                    this.motionFilename = null;

                    try {
                        const data = await API.uploadMotion(file);
                        this.motionInfo = data.motion_info;
                        this.motionFilename = data.filename;
                    } catch (e) {
                        this.motionError = e.message;
                    } finally {
                        this.motionUploading = false;
                    }
                },

                clearMotion() {
                    this.motionInfo = null;
                    this.motionFilename = null;
                    this.motionError = null;
                },

                // Page navigation
                async switchPage(page) {
                    this.currentPage = page;
                    if (page === 'objections') {
                        await this.loadManagedObjections();
                    } else if (page === 'users') {
                        await this.loadManagedUsers();
                    }
                },

                // Objections Management methods
                async loadManagedObjections() {
                    this.objectionError = null;
                    try {
                        const data = await API.getObjections();
                        this.managedObjections = data.objections || [];
                    } catch (e) {
                        this.objectionError = e.message;
                    }
                },

                editObjection(obj) {
                    this.editingObjection = obj;
                    this.objectionForm = {
                        name: obj.name,
                        short_name: obj.short_name,
                        formal_language: obj.formal_language,
                        argument_template: obj.argument_template || ''
                    };
                },

                confirmDeleteObjection(obj) {
                    this.deletingObjection = obj;
                },

                closeObjectionModal() {
                    this.showAddObjection = false;
                    this.editingObjection = null;
                    this.objectionForm = {
                        name: '',
                        short_name: '',
                        formal_language: '',
                        argument_template: ''
                    };
                },

                // Generate a unique ID from short_name
                generateUniqueId(shortName) {
                    // Slugify: lowercase, replace spaces with underscores, remove special chars
                    let baseId = shortName
                        .toLowerCase()
                        .replace(/\s+/g, '_')
                        .replace(/[^a-z0-9_]/g, '');

                    // Check for duplicates
                    const existingIds = this.managedObjections.map(o => o.id);
                    let uniqueId = baseId;
                    let counter = 1;

                    while (existingIds.includes(uniqueId)) {
                        uniqueId = `${baseId}_${counter}`;
                        counter++;
                    }

                    return uniqueId;
                },

                async saveObjection() {
                    this.objectionError = null;
                    this.savingObjection = true;

                    try {
                        if (this.editingObjection) {
                            // Update existing
                            await API.updateObjection(this.editingObjection.id, {
                                name: this.objectionForm.name,
                                short_name: this.objectionForm.short_name,
                                formal_language: this.objectionForm.formal_language,
                                argument_template: this.objectionForm.argument_template
                            });
                        } else {
                            // Create new - generate ID from short_name
                            const newId = this.generateUniqueId(this.objectionForm.short_name);
                            await API.createObjection({
                                id: newId,
                                name: this.objectionForm.name,
                                short_name: this.objectionForm.short_name,
                                formal_language: this.objectionForm.formal_language,
                                argument_template: this.objectionForm.argument_template
                            });
                        }

                        await this.loadManagedObjections();
                        // Also refresh the objections used in RFP tool
                        const data = await API.getObjections();
                        this.objections = data.objections || [];

                        this.closeObjectionModal();
                    } catch (e) {
                        this.objectionError = e.message;
                    } finally {
                        this.savingObjection = false;
                    }
                },

                async deleteObjection() {
                    if (!this.deletingObjection) return;

                    this.objectionError = null;

                    try {
                        await API.deleteObjection(this.deletingObjection.id);
                        await this.loadManagedObjections();
                        // Also refresh the objections used in RFP tool
                        const data = await API.getObjections();
                        this.objections = data.objections || [];

                        this.deletingObjection = null;
                    } catch (e) {
                        this.objectionError = e.message;
                    }
                },

                // User selection methods
                selectUser(user) {
                    this.currentUser = user;
                    this.showUserDropdown = false;
                    localStorage.setItem('currentUserId', user.id);
                },

                signOut() {
                    this.currentUser = null;
                    this.showUserDropdown = false;
                    localStorage.removeItem('currentUserId');
                },

                // Users Management methods
                async loadManagedUsers() {
                    this.userError = null;
                    try {
                        const data = await API.getUsers();
                        this.managedUsers = data.users || [];
                    } catch (e) {
                        this.userError = e.message;
                    }
                },

                editUser(user) {
                    this.editingUser = user;
                    this.userForm = {
                        name: user.name,
                        bar_number: user.bar_number,
                        email: user.email,
                        icon: user.icon || 'üë§'
                    };
                },

                confirmDeleteUser(user) {
                    this.deletingUser = user;
                },

                closeUserModal() {
                    this.showAddUser = false;
                    this.editingUser = null;
                    this.userForm = {
                        name: '',
                        bar_number: '',
                        email: '',
                        icon: 'üë§'
                    };
                },

                async saveUser() {
                    this.userError = null;
                    this.savingUser = true;

                    try {
                        if (this.editingUser) {
                            // Update existing
                            await API.updateUser(this.editingUser.id, {
                                name: this.userForm.name,
                                bar_number: this.userForm.bar_number,
                                email: this.userForm.email,
                                icon: this.userForm.icon
                            });
                        } else {
                            // Create new
                            await API.createUser({
                                name: this.userForm.name,
                                bar_number: this.userForm.bar_number,
                                email: this.userForm.email,
                                icon: this.userForm.icon
                            });
                        }

                        await this.loadManagedUsers();
                        // Also refresh the users dropdown
                        const data = await API.getUsers();
                        this.users = data.users || [];

                        this.closeUserModal();
                    } catch (e) {
                        this.userError = e.message;
                    } finally {
                        this.savingUser = false;
                    }
                },

                async deleteUser() {
                    if (!this.deletingUser) return;

                    this.userError = null;

                    try {
                        await API.deleteUser(this.deletingUser.id);
                        await this.loadManagedUsers();
                        // Also refresh the users dropdown
                        const data = await API.getUsers();
                        this.users = data.users || [];

                        // If deleted user was current user, sign out
                        if (this.currentUser?.id === this.deletingUser.id) {
                            this.signOut();
                        }

                        this.deletingUser = null;
                    } catch (e) {
                        this.userError = e.message;
                    }
                }
            };
        }
    </script>
</body>
</html>
