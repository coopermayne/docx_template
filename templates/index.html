<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Legal Document Tools</title>
    <link rel="stylesheet" href="/static/css/main.css">
    <script defer src="/static/vendor/alpine.min.js"></script>
    <script src="/static/js/api.js"></script>
</head>
<body>
    <div x-data="app()" x-init="init()">
        <!-- Header -->
        <header>
            <div class="container" style="display: flex; justify-content: space-between; align-items: center;">
                <a href="#home" @click.prevent="navigateTo('home')" style="text-decoration: none; color: inherit;">
                    <h1 style="margin: 0;">Legal Document Tools</h1>
                </a>
                <nav class="header-nav">
                    <a class="nav-btn" :class="{ 'active': currentPage === 'rfp' }" href="#rfp" @click="navigateTo('rfp')">
                        RFP Tool
                    </a>
                    <a class="nav-btn" :class="{ 'active': currentPage === 'motion_opposition' }" href="#motion-opposition" @click="navigateTo('motion_opposition')">
                        Document Generator
                    </a>
                    <a x-show="currentUser?.name === 'Cooper Alison-Mayne'" class="nav-btn" :class="{ 'active': currentPage === 'templates' }" href="#templates" @click="navigateTo('templates')">
                        Manage Templates
                    </a>
                    <div class="user-selector" style="margin-left: 1rem; position: relative;">
                        <button class="nav-btn" @click="showUserDropdown = !showUserDropdown" style="display: flex; align-items: center; gap: 0.5rem;">
                            <span x-text="currentUser ? currentUser.icon : 'üë§'" style="font-size: 1.2rem;"></span>
                            <span x-text="currentUser ? currentUser.name : 'Sign In'"></span>
                            <span style="font-size: 0.7rem;">‚ñº</span>
                        </button>
                        <div x-show="showUserDropdown" @click.away="showUserDropdown = false"
                             class="user-dropdown" style="position: absolute; right: 0; top: 100%; background: white; border: 1px solid var(--gray-300); border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); min-width: 220px; z-index: 100; margin-top: 0.5rem;">
                            <div class="dropdown-menu">
                                <!-- Show user list only when not logged in -->
                                <template x-if="!currentUser">
                                    <div>
                                        <template x-for="user in users" :key="user.id">
                                            <a href="#" @click.prevent="selectUser(user)"
                                               class="dropdown-item">
                                                <span x-text="user.icon"></span>
                                                <span x-text="user.name.split(' ')[0]"></span>
                                            </a>
                                        </template>
                                        <div x-show="users.length === 0" class="dropdown-item" style="color: var(--gray-500);">
                                            No users yet
                                        </div>
                                        <div class="dropdown-divider"></div>
                                    </div>
                                </template>
                                <a href="#" @click.prevent="switchPage('users'); showUserDropdown = false" class="dropdown-item">
                                    <span x-text="users.length === 0 ? '+ Add User' : 'Manage Users'"></span>
                                </a>
                                <a href="#" x-show="currentUser" @click.prevent="signOut()" class="dropdown-item">
                                    Sign Out
                                </a>
                            </div>
                        </div>
                    </div>
                </nav>
            </div>
        </header>

        <main class="container">
            <!-- Home Page -->
            <div x-show="currentPage === 'home'">
                <div class="home-hero" style="text-align: center; padding: 3rem 1rem; margin-bottom: 2rem;">
                    <h2 style="font-size: 2.25rem; font-weight: 700; color: var(--gray-900); margin-bottom: 1rem;">
                        AI-Powered Legal Document Generation
                    </h2>
                    <p style="font-size: 1.125rem; color: var(--gray-600); max-width: 600px; margin: 0 auto;">
                        Streamline your legal document workflows with intelligent tools that help you draft responses,
                        oppositions, and more in a fraction of the time.
                    </p>
                </div>

                <!-- Feature Cards -->
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1.5rem; margin-bottom: 3rem;">
                    <!-- RFP Tool Card -->
                    <div class="card feature-card" style="cursor: pointer; transition: transform 0.2s, box-shadow 0.2s;"
                         @click="navigateTo('rfp')"
                         @mouseenter="$el.style.transform = 'translateY(-4px)'; $el.style.boxShadow = '0 12px 24px rgba(0,0,0,0.1)'"
                         @mouseleave="$el.style.transform = ''; $el.style.boxShadow = ''">
                        <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1rem;">
                            <div style="width: 48px; height: 48px; background: #dbeafe; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 1.5rem;">
                                üìã
                            </div>
                            <h3 style="margin: 0; font-size: 1.25rem; color: var(--gray-900);">RFP Response Tool</h3>
                        </div>
                        <p style="color: var(--gray-600); margin: 0 0 1rem 0; line-height: 1.6;">
                            Upload a Request for Production PDF and let AI analyze each request, suggest objections,
                            and match responsive documents. Generate professionally formatted Word documents.
                        </p>
                        <span style="color: var(--primary); font-weight: 500; display: flex; align-items: center; gap: 0.5rem;">
                            Get Started <span style="font-size: 1.2em;">‚Üí</span>
                        </span>
                    </div>

                    <!-- Document Generator Card -->
                    <div class="card feature-card" style="cursor: pointer; transition: transform 0.2s, box-shadow 0.2s;"
                         @click="navigateTo('motion_opposition')"
                         @mouseenter="$el.style.transform = 'translateY(-4px)'; $el.style.boxShadow = '0 12px 24px rgba(0,0,0,0.1)'"
                         @mouseleave="$el.style.transform = ''; $el.style.boxShadow = ''">
                        <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1rem;">
                            <div style="width: 48px; height: 48px; background: #fef3c7; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 1.5rem;">
                                ‚öñÔ∏è
                            </div>
                            <h3 style="margin: 0; font-size: 1.25rem; color: var(--gray-900);">Document Generator</h3>
                        </div>
                        <p style="color: var(--gray-600); margin: 0 0 1rem 0; line-height: 1.6;">
                            Enter case information manually or upload a motion PDF to extract details automatically.
                            Generate formatted legal documents ready for filing.
                        </p>
                        <span style="color: var(--primary); font-weight: 500; display: flex; align-items: center; gap: 0.5rem;">
                            Get Started <span style="font-size: 1.2em;">‚Üí</span>
                        </span>
                    </div>
                </div>

                <!-- Coming Soon Section -->
                <div style="background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%); border-radius: 16px; padding: 2rem; margin-bottom: 2rem;">
                    <h3 style="margin: 0 0 1rem 0; color: var(--gray-800); font-size: 1.25rem;">
                        Coming Soon
                    </h3>
                    <p style="color: var(--gray-600); margin-bottom: 1.5rem;">
                        We're actively developing new tools to help streamline more of your legal document workflows:
                    </p>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
                        <div style="display: flex; align-items: center; gap: 0.75rem; padding: 0.75rem; background: white; border-radius: 8px; border: 1px solid var(--gray-200);">
                            <span style="font-size: 1.25rem;">üìù</span>
                            <div>
                                <div style="font-weight: 500; color: var(--gray-800);">Retainer Agreements</div>
                                <div style="font-size: 0.875rem; color: var(--gray-500);">Client engagement letters</div>
                            </div>
                        </div>
                        <div style="display: flex; align-items: center; gap: 0.75rem; padding: 0.75rem; background: white; border-radius: 8px; border: 1px solid var(--gray-200);">
                            <span style="font-size: 1.25rem;">üìú</span>
                            <div>
                                <div style="font-weight: 500; color: var(--gray-800);">Complaint Drafting</div>
                                <div style="font-size: 0.875rem; color: var(--gray-500);">Initial pleadings</div>
                            </div>
                        </div>
                        <div style="display: flex; align-items: center; gap: 0.75rem; padding: 0.75rem; background: white; border-radius: 8px; border: 1px solid var(--gray-200);">
                            <span style="font-size: 1.25rem;">‚úçÔ∏è</span>
                            <div>
                                <div style="font-weight: 500; color: var(--gray-800);">Declarations</div>
                                <div style="font-size: 0.875rem; color: var(--gray-500);">Witness statements</div>
                            </div>
                        </div>
                        <div style="display: flex; align-items: center; gap: 0.75rem; padding: 0.75rem; background: white; border-radius: 8px; border: 1px solid var(--gray-200);">
                            <span style="font-size: 1.25rem;">üîç</span>
                            <div>
                                <div style="font-weight: 500; color: var(--gray-800);">Discovery Requests</div>
                                <div style="font-size: 0.875rem; color: var(--gray-500);">Interrogatories & RFAs</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div><!-- End Home Page -->

            <!-- RFP Tool Page -->
            <div x-show="currentPage === 'rfp'">

            <!-- How It Works Banner -->
            <div x-show="!rfpHelpDismissed" class="help-banner" style="background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%); border: 1px solid #bfdbfe; border-radius: 12px; padding: 1.25rem; margin-top: 1.5rem; margin-bottom: 1.5rem; position: relative;">
                <button @click="rfpHelpDismissed = true" style="position: absolute; top: 0.75rem; right: 0.75rem; background: none; border: none; cursor: pointer; color: var(--gray-400); font-size: 1.25rem; line-height: 1;" title="Dismiss">&times;</button>
                <h3 style="margin: 0 0 0.75rem 0; font-size: 1rem; color: #1e40af; display: flex; align-items: center; gap: 0.5rem;">
                    <span>üí°</span> How This Tool Works
                </h3>
                <ul style="margin: 0; padding-left: 1.25rem; color: var(--gray-700); font-size: 0.9rem; line-height: 1.7;">
                    <li><strong>Upload</strong> your RFP PDF ‚Äî requests are automatically extracted</li>
                    <li><strong>Add documents</strong> you plan to produce (optional) ‚Äî Bates numbers detected from filenames</li>
                    <li><strong>AI suggests</strong> appropriate objections using preset language ‚Äî review and adjust selections</li>
                    <li><strong>Generate</strong> a professionally formatted Word document ready for filing</li>
                </ul>
                <p style="margin: 0.75rem 0 0 0; font-size: 0.85rem; color: var(--gray-500);">
                    Customize your objection templates via <a href="#" @click.prevent="switchPage('objections')" style="color: #2563eb; font-weight: 500;">Manage Objections</a>
                </p>
            </div>

            <!-- RFP Toolbar -->
            <div style="display: flex; justify-content: flex-start; align-items: center; margin-top: 1.5rem; margin-bottom: 1.5rem;">
                <button class="btn btn-secondary" style="display: flex; align-items: center; gap: 0.5rem;" @click="switchPage('objections')">
                    <span style="font-size: 1.1em;">‚öôÔ∏è</span> Manage Objections
                </button>
            </div>

            <!-- Steps Indicator -->
            <ul class="steps">
                <li class="step"
                    :class="{ 'active': currentStep === 1, 'completed': currentStep > 1 }"
                    @click="goToStep(1)">
                    <span class="step-number">1</span>
                    <span class="step-label">Upload RFP</span>
                </li>
                <li class="step"
                    :class="{ 'active': currentStep === 2, 'completed': currentStep > 2 }"
                    @click="session.id && goToStep(2)">
                    <span class="step-number">2</span>
                    <span class="step-label">Add Documents</span>
                </li>
                <li class="step"
                    :class="{ 'active': currentStep === 3, 'completed': currentStep > 3 }"
                    @click="session.requests.length && goToStep(3)">
                    <span class="step-number">3</span>
                    <span class="step-label">Review & Edit</span>
                </li>
                <li class="step"
                    :class="{ 'active': currentStep === 4 }"
                    @click="session.analysis_complete && goToStep(4)">
                    <span class="step-number">4</span>
                    <span class="step-label">Generate</span>
                </li>
            </ul>

            <!-- Error Alert -->
            <div x-show="error" class="alert alert-error" x-text="error"></div>

            <!-- Step 1: Upload RFP -->
            <div x-show="currentStep === 1" class="card">
                <h2 class="card-title">Upload Request for Production (RFP)</h2>

                <div class="upload-zone"
                     :class="{ 'dragover': isDragging, 'processing': uploading }"
                     @dragover.prevent="isDragging = true"
                     @dragleave.prevent="isDragging = false"
                     @drop.prevent="handleRFPDrop($event)"
                     @click="!uploading && $refs.rfpInput.click()">
                    <div class="upload-zone-icon">üìÑ</div>
                    <div class="upload-zone-text">
                        <template x-if="!uploading">
                            <span>Drag & drop your RFP PDF here, or click to browse</span>
                        </template>
                        <template x-if="uploading">
                            <div style="text-align: center;">
                                <span class="loading">
                                    <span class="spinner"></span>
                                    <span x-text="uploadProgress.message || 'Processing...'"></span>
                                </span>
                                <div x-show="uploadProgress.progress > 0" style="margin-top: 0.75rem;">
                                    <div style="background: var(--gray-200); border-radius: 4px; height: 6px; overflow: hidden; max-width: 200px; margin: 0 auto;">
                                        <div :style="`width: ${uploadProgress.progress}%; background: var(--primary-500); height: 100%; transition: width 0.3s ease;`"></div>
                                    </div>
                                </div>
                            </div>
                        </template>
                    </div>
                    <div class="upload-zone-hint" x-show="!uploading">PDF files only</div>
                </div>
                <input type="file"
                       x-ref="rfpInput"
                       accept=".pdf"
                       style="display: none"
                       @change="handleRFPSelect($event)">

                <!-- Parsed Requests Preview - Editable -->
                <template x-if="session.requests.length > 0">
                    <div style="margin-top: 1.5rem;">
                        <h3 class="card-title">Parsed Requests (<span x-text="session.requests.length"></span> found)</h3>
                        <p style="color: var(--gray-600); margin-bottom: 1rem; font-size: 0.875rem;">
                            Review and edit the parsed requests below. Fix any parsing errors before continuing.
                        </p>
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th style="width: 80px;">Request #</th>
                                    <th>Request Text</th>
                                    <th style="width: 80px;">Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                <template x-for="(request, index) in session.requests" :key="request.id">
                                    <tr>
                                        <td>
                                            <input type="text"
                                                   x-model="request.number"
                                                   class="table-input"
                                                   style="width: 60px; text-align: center;"
                                                   @blur="updateRequest(request)">
                                        </td>
                                        <td>
                                            <textarea x-model="request.text"
                                                      class="table-input"
                                                      rows="3"
                                                      style="width: 100%;"
                                                      @blur="updateRequest(request)"></textarea>
                                        </td>
                                        <td style="text-align: center;">
                                            <button class="btn-icon" @click="removeRequest(index)" title="Remove request">‚úï</button>
                                        </td>
                                    </tr>
                                </template>
                            </tbody>
                        </table>

                        <div class="actions-bar">
                            <button class="btn btn-secondary" @click="addRequest()">+ Add Request</button>
                            <button class="btn btn-primary" @click="saveRequestsAndContinue()">
                                Save & Continue ‚Üí
                            </button>
                        </div>
                    </div>
                </template>
            </div>

            <!-- Step 2: Add Documents -->
            <div x-show="currentStep === 2" class="card">
                <h2 class="card-title">Add Responsive Documents</h2>
                <p style="color: var(--gray-600); margin-bottom: 1rem;">
                    Drag and drop your document files. We'll extract file names and Bates numbers automatically.
                </p>

                <div class="upload-zone"
                     :class="{ 'dragover': isDragging }"
                     @dragover.prevent="isDragging = true"
                     @dragleave.prevent="isDragging = false"
                     @drop.prevent="handleDocsDrop($event)"
                     @click="$refs.docsInput.click()">
                    <div class="upload-zone-icon">üìÅ</div>
                    <div class="upload-zone-text">Drag & drop documents here, or click to browse</div>
                    <div class="upload-zone-hint">We'll extract metadata from the files</div>
                </div>
                <input type="file"
                       x-ref="docsInput"
                       multiple
                       style="display: none"
                       @change="handleDocsSelect($event)">

                <!-- Document List - Table Format -->
                <template x-if="session.documents.length > 0">
                    <div style="margin-top: 1.5rem;">
                        <h3 class="card-title">Documents (<span x-text="session.documents.length"></span>)</h3>
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Filename</th>
                                    <th style="width: 120px;">Bates Start</th>
                                    <th style="width: 120px;">Bates End</th>
                                    <th style="width: 200px;">Description</th>
                                    <th style="width: 60px;">Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                <template x-for="doc in session.documents" :key="doc.id">
                                    <tr>
                                        <td>
                                            <input type="text"
                                                   x-model="doc.filename"
                                                   class="table-input"
                                                   style="width: 100%;"
                                                   @blur="updateDocMeta(doc)">
                                        </td>
                                        <td>
                                            <input type="text"
                                                   x-model="doc.bates_start"
                                                   class="table-input"
                                                   placeholder="e.g., ABC001"
                                                   @blur="updateDocMeta(doc)">
                                        </td>
                                        <td>
                                            <input type="text"
                                                   x-model="doc.bates_end"
                                                   class="table-input"
                                                   placeholder="e.g., ABC050"
                                                   @blur="updateDocMeta(doc)">
                                        </td>
                                        <td>
                                            <input type="text"
                                                   x-model="doc.description"
                                                   class="table-input"
                                                   placeholder="Brief description"
                                                   @blur="updateDocMeta(doc)">
                                        </td>
                                        <td style="text-align: center;">
                                            <button class="btn-icon" @click="removeDocument(doc.id)" title="Remove">‚úï</button>
                                        </td>
                                    </tr>
                                </template>
                            </tbody>
                        </table>
                    </div>
                </template>

                <div class="actions-bar">
                    <button class="btn btn-secondary" @click="goToStep(1)">‚Üê Back</button>
                    <button class="btn btn-primary" @click="runAnalysis()" :disabled="analyzing" style="min-width: 180px;">
                        <template x-if="!analyzing">
                            <span>Analyze with AI ‚Üí</span>
                        </template>
                        <template x-if="analyzing">
                            <span class="loading" style="padding: 0;">
                                <span class="spinner"></span>
                                <span x-text="analysisProgress.totalChunks > 1 ? `Analyzing... ${analysisProgress.progress}%` : 'Analyzing...'"></span>
                            </span>
                        </template>
                    </button>
                </div>
                <!-- Progress indicator for long analyses -->
                <div x-show="analyzing && analysisProgress.totalChunks > 1" class="analysis-progress" style="margin-top: 1rem;">
                    <div class="progress-bar-container" style="background: var(--gray-200); border-radius: 4px; height: 8px; overflow: hidden;">
                        <div class="progress-bar-fill" :style="`width: ${analysisProgress.progress}%; background: var(--primary-500); height: 100%; transition: width 0.3s ease;`"></div>
                    </div>
                    <p style="margin-top: 0.5rem; color: var(--gray-600); font-size: 0.875rem;" x-text="analysisProgress.message"></p>
                </div>
            </div>

            <!-- Step 3: Review & Edit -->
            <div x-show="currentStep === 3" class="card">
                <h2 class="card-title">Review AI Suggestions</h2>
                <p style="color: var(--gray-600); margin-bottom: 1rem;">
                    Review and edit the suggested objections and responsive documents for each request.
                </p>

                <div class="review-grid">
                    <template x-for="request in session.requests" :key="request.id">
                        <div class="review-request">
                            <div class="review-request-header">
                                <div class="request-header">
                                    <span class="request-number">Request #<span x-text="request.number"></span></span>
                                    <label style="margin-left: auto; display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                                        <input type="checkbox" x-model="request.include_in_response">
                                        Include in response
                                    </label>
                                </div>
                                <div class="request-text" x-text="request.text"></div>
                            </div>
                            <div class="review-request-body">
                                <!-- Objections -->
                                <div class="review-section">
                                    <div class="review-section-title">Objections</div>
                                    <div class="checkbox-grid">
                                        <template x-for="obj in objections" :key="obj.id">
                                            <label class="checkbox-item"
                                                   :class="{ 'selected': request.selected_objections.includes(obj.id) }"
                                                   :title="request.objection_reasoning && request.objection_reasoning[obj.id] ? request.objection_reasoning[obj.id] : ''"
                                                   @click="toggleObjection(request, obj.id)">
                                                <span x-text="obj.short_name"></span>
                                            </label>
                                        </template>
                                    </div>
                                </div>

                                <!-- Responsive Documents -->
                                <div class="review-section">
                                    <div class="review-section-title">Responsive Documents</div>
                                    <div class="multi-select">
                                        <template x-for="doc in session.documents" :key="doc.id">
                                            <label class="multi-select-item"
                                                   :class="{ 'selected': request.selected_documents.includes(doc.id) }"
                                                   @click="toggleDocument(request, doc.id)">
                                                <span x-text="doc.filename"></span>
                                            </label>
                                        </template>
                                    </div>
                                    <div x-show="session.documents.length === 0" style="color: var(--gray-500); font-size: 0.875rem;">
                                        No documents added
                                    </div>
                                </div>

                                <!-- AI Notes -->
                                <div class="review-section" x-show="request.ai_notes">
                                    <div class="review-section-title">AI Notes</div>
                                    <div class="ai-notes" x-text="request.ai_notes"></div>
                                </div>

                            </div>
                        </div>
                    </template>
                </div>

                <div class="actions-bar">
                    <button class="btn btn-secondary" @click="goToStep(2)">‚Üê Back</button>
                    <button class="btn btn-primary" @click="saveAndContinue()">
                        Save & Continue ‚Üí
                    </button>
                </div>
            </div>

            <!-- Step 4: Generate -->
            <div x-show="currentStep === 4" class="card">
                <h2 class="card-title">Generate Response Document</h2>

                <div class="alert alert-info">
                    Ready to generate your RFP response document with:
                    <ul style="margin-top: 0.5rem; margin-left: 1.5rem;">
                        <li><span x-text="session.requests.filter(r => r.include_in_response).length"></span> requests included</li>
                        <li><span x-text="session.documents.length"></span> responsive documents referenced</li>
                    </ul>
                </div>

                <div style="text-align: center; padding: 2rem; display: flex; gap: 1rem; justify-content: center; flex-wrap: wrap;">
                    <button class="btn btn-success" style="font-size: 1rem; padding: 1rem 2rem;"
                            @click="generateDocument(false)" :disabled="generating">
                        <template x-if="!generating">
                            <span>üìÑ Generate Document</span>
                        </template>
                        <template x-if="generating">
                            <span class="loading" style="padding: 0;">
                                <span class="spinner"></span>
                                Generating...
                            </span>
                        </template>
                    </button>
                </div>

                <div class="actions-bar">
                    <button class="btn btn-secondary" @click="goToStep(3)">‚Üê Back to Review</button>
                    <button class="btn btn-secondary" @click="startOver()">Start New Session</button>
                </div>
            </div>
            </div><!-- End RFP Tool Page -->

            <!-- Document Generator Page -->
            <div x-show="currentPage === 'motion_opposition'" x-init="initDocGenerator()">
                <!-- Error Alert -->
                <div x-show="motionError" class="alert alert-error" x-text="motionError"></div>

                <!-- Extraction Modal -->
                <template x-if="motionUploading">
                    <div style="position: fixed; inset: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 1000;">
                        <div class="card" style="max-width: 400px; text-align: center;">
                            <div style="font-size: 3rem; margin-bottom: 1rem;">üìÑ</div>
                            <h3 style="margin: 0 0 0.5rem 0;">Extracting Information</h3>
                            <p style="color: var(--gray-600); margin-bottom: 1.5rem;">Analyzing document...</p>
                            <div class="loading" style="justify-content: center;">
                                <span class="spinner"></span>
                            </div>
                        </div>
                    </div>
                </template>

                <div class="card">
                    <h2 class="card-title" style="margin-bottom: 0.5rem;">Document Generator</h2>
                    <p style="color: var(--gray-600); margin: 0 0 1rem 0;">
                        <template x-if="motionFilename">
                            <span>Source: <span x-text="motionFilename" style="font-weight: 500;"></span>
                                <button @click="$refs.motionInput.click()" class="btn btn-secondary" style="padding: 0.25rem 0.5rem; font-size: 0.75rem; margin-left: 0.5rem;">Change</button>
                            </span>
                        </template>
                        <template x-if="!motionFilename">
                            <span>Enter information manually or upload a PDF to extract automatically</span>
                        </template>
                    </p>

                    <!-- Upload Drop Zone -->
                    <div class="upload-zone"
                         :class="{ 'dragover': motionDragging }"
                         @dragover.prevent="motionDragging = true"
                         @dragleave.prevent="motionDragging = false"
                         @drop.prevent="handleMotionDrop($event)"
                         @click="$refs.motionInput.click()"
                         style="margin-bottom: 1.5rem; padding: 1.5rem; cursor: pointer; border: 2px dashed var(--gray-300); border-radius: 8px; display: flex; align-items: center; justify-content: center; gap: 1rem; transition: all 0.2s; background: var(--gray-50);"
                         :style="motionDragging ? 'border-color: var(--primary); background: #f0f9ff;' : ''">
                        <span style="font-size: 2rem;">üìÑ</span>
                        <div>
                            <div style="font-weight: 500; color: var(--gray-700);">Drop a PDF here to extract case information</div>
                            <div style="font-size: 0.875rem; color: var(--gray-500);">or click to browse</div>
                        </div>
                    </div>
                    <input type="file"
                           x-ref="motionInput"
                           accept=".pdf"
                           style="display: none"
                           @change="handleMotionSelect($event)">

                    <!-- Document Info Form -->
                    <div class="motion-info-grid" style="display: grid; gap: 1rem; margin-bottom: 1.5rem;">
                        <!-- Section 1: Case Information -->
                        <div style="background: var(--gray-50); border: 1px solid var(--gray-200); border-radius: 8px; padding: 1rem;">
                            <h4 style="margin: 0 0 1rem 0; color: var(--gray-700); font-size: 0.875rem; text-transform: uppercase; letter-spacing: 0.05em;">Case Information</h4>
                            <div style="display: grid; gap: 0.75rem;">
                                <!-- Court -->
                                <div class="info-row" style="display: grid; grid-template-columns: 140px 1fr; gap: 0.5rem; align-items: start;">
                                    <label style="color: var(--gray-500); font-size: 0.875rem; padding-top: 0.5rem;">Court:<span style="color: #ef4444;">*</span></label>
                                    <textarea x-model="motionTemplateVars.court_name"
                                              @blur="saveField('court_name')"
                                              class="form-input"
                                              :style="hasFieldError('court_name') ? 'border-color: #ef4444; background-color: #fef2f2;' : ''"
                                              style="padding: 0.5rem; font-size: 0.875rem; min-height: 3.5rem; resize: vertical;"
                                              placeholder="UNITED STATES DISTRICT COURT&#10;CENTRAL DISTRICT OF CALIFORNIA"></textarea>
                                </div>
                                <!-- Case Number -->
                                <div class="info-row" style="display: grid; grid-template-columns: 140px 1fr; gap: 0.5rem; align-items: center;">
                                    <label style="color: var(--gray-500); font-size: 0.875rem;">Case Number:<span style="color: #ef4444;">*</span></label>
                                    <input type="text"
                                           x-model="motionTemplateVars.case_number"
                                           @blur="saveField('case_number')"
                                           class="form-input"
                                           :style="hasFieldError('case_number') ? 'border-color: #ef4444; background-color: #fef2f2;' : ''"
                                           style="padding: 0.5rem; font-size: 0.875rem;"
                                           placeholder="2:24-cv-01234-ABC-XYZ">
                                </div>
                                <!-- Plaintiff Caption -->
                                <div class="info-row" style="display: grid; grid-template-columns: 140px 1fr; gap: 0.5rem; align-items: start;">
                                    <label style="color: var(--gray-500); font-size: 0.875rem; padding-top: 0.5rem;">Plaintiff(s):<span style="color: #ef4444;">*</span></label>
                                    <textarea x-model="motionTemplateVars.plaintiff_caption"
                                              @blur="saveField('plaintiff_caption')"
                                              @keydown.enter.prevent
                                              @input="motionTemplateVars.plaintiff_caption = $event.target.value.replace(/[\r\n]+/g, ' ')"
                                              class="form-input"
                                              :style="hasFieldError('plaintiff_caption') ? 'border-color: #ef4444; background-color: #fef2f2;' : ''"
                                              style="padding: 0.5rem; font-size: 0.875rem; min-height: 2.5rem; resize: vertical;"
                                              placeholder="JOHN DOE"></textarea>
                                </div>
                                <!-- Defendant Caption -->
                                <div class="info-row" style="display: grid; grid-template-columns: 140px 1fr; gap: 0.5rem; align-items: start;">
                                    <label style="color: var(--gray-500); font-size: 0.875rem; padding-top: 0.5rem;">Defendant(s):<span style="color: #ef4444;">*</span></label>
                                    <textarea x-model="motionTemplateVars.defendant_caption"
                                              @blur="saveField('defendant_caption')"
                                              @keydown.enter.prevent
                                              @input="motionTemplateVars.defendant_caption = $event.target.value.replace(/[\r\n]+/g, ' ')"
                                              class="form-input"
                                              :style="hasFieldError('defendant_caption') ? 'border-color: #ef4444; background-color: #fef2f2;' : ''"
                                              style="padding: 0.5rem; font-size: 0.875rem; min-height: 2.5rem; resize: vertical;"
                                              placeholder="ACME CORPORATION"></textarea>
                                </div>
                                <!-- Judge -->
                                <div class="info-row" style="display: grid; grid-template-columns: 140px 1fr; gap: 0.5rem; align-items: center;">
                                    <label style="color: var(--gray-500); font-size: 0.875rem;">Judge:<span style="color: #ef4444;">*</span></label>
                                    <input type="text"
                                           x-model="motionTemplateVars.judge_name"
                                           @blur="saveField('judge_name')"
                                           class="form-input"
                                           :style="hasFieldError('judge_name') ? 'border-color: #ef4444; background-color: #fef2f2;' : ''"
                                           style="padding: 0.5rem; font-size: 0.875rem;"
                                           placeholder="Judge Smith">
                                </div>
                                <!-- Magistrate Judge -->
                                <div class="info-row" style="display: grid; grid-template-columns: 140px 1fr; gap: 0.5rem; align-items: center;">
                                    <label style="color: var(--gray-500); font-size: 0.875rem;">Magistrate Judge:</label>
                                    <input type="text"
                                           x-model="motionTemplateVars.mag_judge_name"
                                           @blur="saveField('mag_judge_name')"
                                           class="form-input"
                                           style="padding: 0.5rem; font-size: 0.875rem;"
                                           placeholder="Magistrate Judge Doe">
                                </div>
                                <!-- Motion Title -->
                                <div class="info-row" style="display: grid; grid-template-columns: 140px 1fr; gap: 0.5rem; align-items: center;">
                                    <label style="color: var(--gray-500); font-size: 0.875rem;">Motion Title:</label>
                                    <input type="text"
                                           x-model="motionTemplateVars.motion_title"
                                           @blur="saveField('motion_title')"
                                           class="form-input"
                                           style="padding: 0.5rem; font-size: 0.875rem;"
                                           placeholder="Motion to Compel Discovery">
                                </div>
                            </div>
                        </div>

                        <!-- Section 2: Hearing Information (Optional) -->
                        <div style="background: #fef3c7; border: 1px solid #f59e0b; border-radius: 8px; padding: 1rem;">
                            <h4 style="margin: 0 0 1rem 0; color: #92400e; font-size: 0.875rem; text-transform: uppercase; letter-spacing: 0.05em;">Hearing Information <span style="font-weight: normal; text-transform: none;">(Optional)</span></h4>
                            <div style="display: grid; gap: 0.75rem;">
                                <!-- Hearing Date -->
                                <div class="info-row" style="display: grid; grid-template-columns: 140px 1fr; gap: 0.5rem; align-items: center;">
                                    <label style="color: var(--gray-500); font-size: 0.875rem;">Hearing Date:</label>
                                    <input type="text"
                                           x-model="motionTemplateVars.hearing_date"
                                           @blur="saveField('hearing_date')"
                                           class="form-input"
                                           style="padding: 0.5rem; font-size: 0.875rem;"
                                           placeholder="e.g., January 15, 2025">
                                </div>
                                <!-- Hearing Time -->
                                <div class="info-row" style="display: grid; grid-template-columns: 140px 1fr; gap: 0.5rem; align-items: center;">
                                    <label style="color: var(--gray-500); font-size: 0.875rem;">Hearing Time:</label>
                                    <input type="text"
                                           x-model="motionTemplateVars.hearing_time"
                                           @blur="saveField('hearing_time')"
                                           class="form-input"
                                           style="padding: 0.5rem; font-size: 0.875rem;"
                                           placeholder="e.g., 10:00 a.m.">
                                </div>
                                <!-- Hearing Location -->
                                <div class="info-row" style="display: grid; grid-template-columns: 140px 1fr; gap: 0.5rem; align-items: center;">
                                    <label style="color: var(--gray-500); font-size: 0.875rem;">Courtroom:</label>
                                    <input type="text"
                                           x-model="motionTemplateVars.hearing_location"
                                           @blur="saveField('hearing_location')"
                                           class="form-input"
                                           style="padding: 0.5rem; font-size: 0.875rem;"
                                           placeholder="e.g., Courtroom 10A or 350">
                                </div>
                            </div>
                        </div>

                        <!-- Section 3: Document Details -->
                        <div style="background: #f0fdf4; border: 1px solid #86efac; border-radius: 8px; padding: 1rem;">
                            <h4 style="margin: 0 0 1rem 0; color: #166534; font-size: 0.875rem; text-transform: uppercase; letter-spacing: 0.05em;">Document Details</h4>
                            <div style="display: grid; gap: 0.75rem;">
                                <!-- Document Title -->
                                <div class="info-row" style="display: grid; grid-template-columns: 140px 1fr auto; gap: 0.5rem; align-items: center;">
                                    <span style="color: var(--gray-500); font-size: 0.875rem;">Document Title:<span style="color: #ef4444;">*</span></span>
                                    <input type="text"
                                           x-model="documentTitle"
                                           @blur="validateField('documentTitle')"
                                           class="form-input"
                                           :style="hasFieldError('documentTitle') ? 'border-color: #ef4444; background-color: #fef2f2;' : ''"
                                           style="padding: 0.5rem; font-size: 0.875rem;"
                                           placeholder="e.g., Opposition to Motion to Compel">
                                    <button x-show="motionFilename"
                                            @click="suggestDocumentTitle()"
                                            :disabled="suggestingTitle"
                                            class="btn btn-secondary"
                                            style="padding: 0.4rem 0.75rem; font-size: 0.75rem; white-space: nowrap;"
                                            title="Suggest a title based on the motion">
                                        <template x-if="!suggestingTitle">
                                            <span>Suggest</span>
                                        </template>
                                        <template x-if="suggestingTitle">
                                            <span class="spinner" style="width: 12px; height: 12px;"></span>
                                        </template>
                                    </button>
                                </div>
                                <!-- Document Options -->
                                <div style="display: flex; flex-wrap: wrap; gap: 1.5rem; margin-top: 0.5rem;">
                                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; font-size: 0.875rem;">
                                        <input type="checkbox"
                                               x-model="motionTemplateVars.is_joint"
                                               @change="saveField('is_joint')"
                                               style="width: 1rem; height: 1rem; cursor: pointer;">
                                        <span style="color: var(--gray-700);">Joint Filing</span>
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; font-size: 0.875rem;">
                                        <input type="checkbox"
                                               x-model="motionTemplateVars.cert_of_compliance"
                                               @change="saveField('cert_of_compliance')"
                                               style="width: 1rem; height: 1rem; cursor: pointer;">
                                        <span style="color: var(--gray-700);">Certificate of Compliance</span>
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; font-size: 0.875rem;">
                                        <input type="checkbox"
                                               x-model="motionTemplateVars.notice_and_confer"
                                               @change="saveField('notice_and_confer')"
                                               style="width: 1rem; height: 1rem; cursor: pointer;">
                                        <span style="color: var(--gray-700);">Meet and Confer</span>
                                    </label>
                                </div>
                            </div>
                        </div>

                        <!-- Section 4: Signing Attorney -->
                        <div style="background: #e8f4fd; border: 1px solid #3b82f6; border-radius: 8px; padding: 1rem;">
                            <h4 style="margin: 0 0 1rem 0; color: #1e40af; font-size: 0.875rem; text-transform: uppercase; letter-spacing: 0.05em;">Signing Attorney</h4>
                            <template x-if="currentUser">
                                <div style="display: grid; gap: 0.75rem;">
                                    <div class="info-row" style="display: grid; grid-template-columns: 140px 1fr; gap: 0.5rem;">
                                        <span style="color: var(--gray-500); font-size: 0.875rem;">Name:</span>
                                        <span style="font-weight: 500;" x-text="currentUser.name"></span>
                                    </div>
                                    <div class="info-row" style="display: grid; grid-template-columns: 140px 1fr; gap: 0.5rem;">
                                        <span style="color: var(--gray-500); font-size: 0.875rem;">Bar Number:</span>
                                        <span style="font-weight: 500;" x-text="currentUser.bar_number"></span>
                                    </div>
                                    <div class="info-row" style="display: grid; grid-template-columns: 140px 1fr; gap: 0.5rem;">
                                        <span style="color: var(--gray-500); font-size: 0.875rem;">Email:</span>
                                        <span style="font-weight: 500;" x-text="currentUser.email"></span>
                                    </div>
                                </div>
                            </template>
                            <template x-if="!currentUser">
                                <p style="color: #b45309; margin: 0;">
                                    Please sign in to generate documents. <a href="#" @click.prevent="showUserDropdown = true" style="color: #3b82f6;">Sign in now</a>
                                </p>
                            </template>
                        </div>
                    </div>

                    <!-- Actions -->
                    <div class="actions-bar">
                        <button class="btn btn-secondary" @click="clearMotion()">Start Over</button>
                        <button class="btn btn-success"
                                @click="generateMotionDocument()"
                                :disabled="motionGenerating || !currentUser || !canGenerateDocument()"
                                :title="!currentUser ? 'Please sign in first' : (!canGenerateDocument() ? 'Missing: ' + getMissingRequiredFields().join(', ') : 'Generate document')"
                                style="font-size: 1rem; padding: 0.75rem 1.5rem;">
                            <template x-if="!motionGenerating">
                                <span>Generate Document</span>
                            </template>
                            <template x-if="motionGenerating">
                                <span class="loading" style="padding: 0;">
                                    <span class="spinner"></span>
                                    Generating...
                                </span>
                            </template>
                        </button>
                    </div>
                </div>
            </div><!-- End Document Generator Page -->

            <!-- Manage Objections Page -->
            <div x-show="currentPage === 'objections'">
                <div class="card">
                    <a href="#" @click.prevent="switchPage('rfp')" style="display: inline-flex; align-items: center; gap: 0.25rem; color: var(--gray-500); text-decoration: none; font-size: 0.875rem; margin-bottom: 1rem;">
                        ‚Üê Back to RFP Tool
                    </a>
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                        <h2 class="card-title" style="margin: 0;">Manage Objections</h2>
                        <button class="btn btn-primary" @click="showAddObjection = true">+ Add Objection</button>
                    </div>

                    <p style="color: var(--gray-600); margin-bottom: 1.5rem;">
                        Configure the objections available when responding to RFP requests. Changes apply to all future sessions.
                    </p>

                    <!-- Error Alert -->
                    <div x-show="objectionError" class="alert alert-error" x-text="objectionError"></div>

                    <!-- Objections List -->
                    <div class="objections-list">
                        <template x-for="(obj, index) in managedObjections" :key="obj.id">
                            <div class="objection-item">
                                <div class="objection-item-header">
                                    <div class="objection-item-title">
                                        <span class="objection-badge" x-text="obj.short_name"></span>
                                        <strong x-text="obj.name"></strong>
                                    </div>
                                    <div class="objection-item-actions">
                                        <button class="btn btn-sm btn-secondary" @click="editObjection(obj)">Edit</button>
                                    </div>
                                </div>
                                <div class="objection-item-body">
                                    <div class="objection-field">
                                        <label>Formal Language:</label>
                                        <p x-text="obj.formal_language"></p>
                                    </div>
                                    <div class="objection-field" x-show="obj.argument_template">
                                        <label>Argument Template:</label>
                                        <p x-text="obj.argument_template"></p>
                                    </div>
                                </div>
                            </div>
                        </template>
                    </div>

                    <div x-show="managedObjections.length === 0" style="text-align: center; padding: 2rem; color: var(--gray-500);">
                        No objections configured. Click "Add Objection" to create one.
                    </div>
                </div>
            </div><!-- End Manage Objections Page -->

            <!-- Manage Users Page -->
            <div x-show="currentPage === 'users'">
                <div class="card">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                        <h2 class="card-title" style="margin: 0;">Manage Users</h2>
                        <button class="btn btn-primary" @click="showAddUser = true">+ Add User</button>
                    </div>

                    <p style="color: var(--gray-600); margin-bottom: 1.5rem;">
                        Configure attorney users who can sign in and generate documents.
                    </p>

                    <!-- Error Alert -->
                    <div x-show="userError" class="alert alert-error" x-text="userError"></div>

                    <!-- Users List -->
                    <div class="objections-list">
                        <template x-for="user in managedUsers" :key="user.id">
                            <div class="objection-item">
                                <div class="objection-item-header">
                                    <div class="objection-item-title" style="display: flex; align-items: center; gap: 0.75rem;">
                                        <span x-text="user.icon" style="font-size: 1.5rem;"></span>
                                        <div>
                                            <strong x-text="user.name"></strong>
                                            <div style="font-size: 0.875rem; color: var(--gray-500);">
                                                Bar #<span x-text="user.bar_number"></span>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="objection-item-actions">
                                        <button class="btn btn-sm btn-secondary" @click="editUser(user)">Edit</button>
                                    </div>
                                </div>
                                <div class="objection-item-body">
                                    <div class="objection-field">
                                        <label>Email:</label>
                                        <p x-text="user.email"></p>
                                    </div>
                                </div>
                            </div>
                        </template>
                    </div>

                    <div x-show="managedUsers.length === 0" style="text-align: center; padding: 2rem; color: var(--gray-500);">
                        No users configured. Click "Add User" to create one.
                    </div>
                </div>
            </div><!-- End Manage Users Page -->

            <!-- Manage Templates Page (admin only) -->
            <div x-show="currentPage === 'templates' && currentUser?.name === 'Cooper Alison-Mayne'">
                <div style="margin-top: 1.5rem;">
                    <h2 style="font-size: 1.5rem; font-weight: 600; color: var(--gray-900); margin-bottom: 0.5rem;">Manage Templates</h2>
                    <p style="color: var(--gray-600); margin-bottom: 2rem;">
                        Upload and manage Word document templates. The most recent template of each type will be used when generating documents.
                    </p>

                    <!-- Sign in prompt -->
                    <template x-if="!currentUser">
                        <div class="alert alert-info" style="margin-bottom: 1.5rem;">
                            Please <a href="#" @click.prevent="showUserDropdown = true" style="color: #3b82f6; font-weight: 500;">sign in</a> to upload and manage templates.
                        </div>
                    </template>

                    <!-- Error Alert -->
                    <div x-show="templatesError" class="alert alert-error" style="margin-bottom: 1.5rem;" x-text="templatesError"></div>

                    <!-- Hidden file input -->
                    <input type="file"
                           x-ref="templateInput"
                           accept=".docx"
                           style="display: none"
                           @change="handleTemplateFileSelect($event)">

                    <!-- Loading state -->
                    <div x-show="templatesLoading" style="text-align: center; padding: 2rem;">
                        <span class="loading"><span class="spinner"></span> Loading templates...</span>
                    </div>

                    <div x-show="!templatesLoading">
                        <!-- Dynamic Template Sections -->
                        <template x-for="typeInfo in templateTypes" :key="typeInfo">
                            <div class="template-section" style="margin-bottom: 2.5rem;">
                                <h3 style="font-size: 1.125rem; font-weight: 600; color: var(--gray-800); margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                                    <span style="display: inline-flex; align-items: center; justify-content: center; width: 28px; height: 28px; border-radius: 6px;"
                                          :style="{ background: getCategoryColor(typeInfo) }"
                                          x-text="getCategoryIcon(typeInfo)"></span>
                                    <span x-text="formatCategoryName(typeInfo)"></span> Templates
                                </h3>
                                <div class="template-grid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 1rem;">
                                    <!-- Existing templates for this type -->
                                    <template x-for="template in templates.filter(t => t.type === typeInfo)" :key="template.id">
                                        <div class="template-tile">
                                            <div class="template-tile-header">
                                                <span style="font-size: 1.5rem;">üìÑ</span>
                                                <div style="flex: 1; min-width: 0;">
                                                    <div style="font-weight: 500; color: var(--gray-900); white-space: nowrap; overflow: hidden; text-overflow: ellipsis;" x-text="template.name"></div>
                                                    <div style="font-size: 0.75rem; color: var(--gray-500);">
                                                        <span x-text="getInitials(template.uploaded_by_name)"></span> ¬∑ <span x-text="formatDate(template.created_at)"></span>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="template-tile-actions" x-show="currentUser">
                                                <button class="btn btn-sm btn-secondary" @click="downloadTemplate(template)">Download</button>
                                                <button class="btn btn-sm btn-danger" @click="confirmDeleteTemplate(template)">Delete</button>
                                            </div>
                                        </div>
                                    </template>

                                    <!-- Upload dropzone tile -->
                                    <div class="template-tile template-upload-tile"
                                         :class="{ 'dragover': templateDragStates[typeInfo], 'disabled': !currentUser }"
                                         x-show="currentUser"
                                         @click="templateUploadType = typeInfo; $refs.templateInput.click()"
                                         @dragover.prevent="templateDragStates[typeInfo] = true"
                                         @dragleave.prevent="templateDragStates[typeInfo] = false"
                                         @drop.prevent="handleTemplateDropForType($event, typeInfo)">
                                        <div style="text-align: center; color: var(--gray-400);">
                                            <div style="font-size: 2rem; margin-bottom: 0.5rem;">+</div>
                                            <div style="font-size: 0.875rem;" x-text="templateUploadStates[typeInfo] ? 'Uploading...' : 'Drop or click to upload'"></div>
                                        </div>
                                    </div>
                                </div>
                                <div x-show="templates.filter(t => t.type === typeInfo).length === 0 && !currentUser" style="color: var(--gray-500); font-size: 0.875rem; padding: 1rem; background: var(--gray-50); border-radius: 8px; text-align: center;">
                                    No <span x-text="formatCategoryName(typeInfo).toLowerCase()"></span> templates uploaded yet.
                                </div>
                            </div>
                        </template>

                        <!-- Add New Category Button -->
                        <div x-show="currentUser" style="margin-top: 1rem;">
                            <button class="btn btn-secondary" @click="showNewCategoryModal = true" style="display: flex; align-items: center; gap: 0.5rem;">
                                <span style="font-size: 1.25rem;">+</span> Add New Category
                            </button>
                        </div>
                    </div>
                </div>
            </div><!-- End Manage Templates Page -->

            <!-- Delete Template Confirmation Modal -->
            <div x-show="deletingTemplate" class="modal-overlay" @click.self="deletingTemplate = null">
                <div class="modal" style="max-width: 400px;">
                    <div class="modal-header">
                        <h3>Delete Template</h3>
                        <button class="btn-icon" @click="deletingTemplate = null">&times;</button>
                    </div>
                    <div class="modal-body">
                        <p>Are you sure you want to delete "<strong x-text="deletingTemplate?.name"></strong>"?</p>
                        <p style="color: var(--gray-600); font-size: 0.875rem; margin-top: 0.5rem;">This action cannot be undone.</p>
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-secondary" @click="deletingTemplate = null">Cancel</button>
                        <button class="btn btn-danger" @click="deleteTemplate()">Delete</button>
                    </div>
                </div>
            </div>

            <!-- New Category Modal -->
            <div x-show="showNewCategoryModal" class="modal-overlay" @click.self="showNewCategoryModal = false; newCategoryName = ''">
                <div class="modal" style="max-width: 400px;">
                    <div class="modal-header">
                        <h3>Add New Category</h3>
                        <button class="btn-icon" @click="showNewCategoryModal = false; newCategoryName = ''">&times;</button>
                    </div>
                    <div class="modal-body">
                        <div class="form-group">
                            <label for="newCategoryName">Category Name</label>
                            <input type="text"
                                   id="newCategoryName"
                                   x-model="newCategoryName"
                                   placeholder="e.g., discovery, motion, pleading"
                                   @keydown.enter="createNewCategory()"
                                   style="width: 100%;">
                            <small style="color: var(--gray-500); display: block; margin-top: 0.25rem;">
                                Use lowercase letters, numbers, hyphens, or underscores only.
                            </small>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-secondary" @click="showNewCategoryModal = false; newCategoryName = ''">Cancel</button>
                        <button class="btn btn-primary"
                                @click="createNewCategory()"
                                :disabled="!newCategoryName.trim()">
                            Create & Upload Template
                        </button>
                    </div>
                </div>
            </div>

            <!-- Add/Edit User Modal -->
            <div x-show="showAddUser || editingUser" class="modal-overlay" @click.self="closeUserModal()">
                <div class="modal">
                    <div class="modal-header">
                        <h3 x-text="editingUser ? 'Edit User' : 'Add New User'"></h3>
                        <button class="btn-icon" @click="closeUserModal()">&times;</button>
                    </div>
                    <div class="modal-body">
                        <div class="form-group">
                            <label>Name</label>
                            <input type="text" x-model="userForm.name"
                                   placeholder="e.g., John Smith"
                                   class="form-input">
                        </div>
                        <div class="form-group">
                            <label>Bar Number</label>
                            <input type="text" x-model="userForm.bar_number"
                                   placeholder="e.g., 123456"
                                   class="form-input">
                        </div>
                        <div class="form-group">
                            <label>Email</label>
                            <input type="email" x-model="userForm.email"
                                   placeholder="e.g., john@lawfirm.com"
                                   class="form-input">
                        </div>
                        <div class="form-group">
                            <label>Icon</label>
                            <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                                <template x-for="icon in userIcons" :key="icon">
                                    <button type="button"
                                            @click="userForm.icon = icon"
                                            style="padding: 0.5rem; font-size: 1.5rem; border: 2px solid; border-radius: 8px; cursor: pointer; background: white;"
                                            :style="userForm.icon === icon ? 'border-color: var(--primary); background: var(--primary-light);' : 'border-color: var(--gray-300);'"
                                            x-text="icon"></button>
                                </template>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button x-show="editingUser" class="btn btn-danger" style="margin-right: auto;" @click="confirmDeleteUser(editingUser)">Delete</button>
                        <button class="btn btn-secondary" @click="closeUserModal()">Cancel</button>
                        <button class="btn btn-primary" @click="saveUser()" :disabled="savingUser">
                            <span x-show="!savingUser" x-text="editingUser ? 'Save Changes' : 'Add User'"></span>
                            <span x-show="savingUser" class="loading"><span class="spinner"></span> Saving...</span>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Delete User Confirmation Modal -->
            <div x-show="deletingUser" class="modal-overlay" @click.self="deletingUser = null">
                <div class="modal" style="max-width: 400px;">
                    <div class="modal-header">
                        <h3>Delete User</h3>
                        <button class="btn-icon" @click="deletingUser = null">&times;</button>
                    </div>
                    <div class="modal-body">
                        <p>Are you sure you want to delete "<strong x-text="deletingUser?.name"></strong>"?</p>
                        <p style="color: var(--gray-600); font-size: 0.875rem; margin-top: 0.5rem;">This action cannot be undone.</p>
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-secondary" @click="deletingUser = null">Cancel</button>
                        <button class="btn btn-danger" @click="deleteUser()">Delete</button>
                    </div>
                </div>
            </div>

            <!-- Add/Edit Objection Modal -->
            <div x-show="showAddObjection || editingObjection" class="modal-overlay" @click.self="closeObjectionModal()">
                <div class="modal">
                    <div class="modal-header">
                        <h3 x-text="editingObjection ? 'Edit Objection' : 'Add New Objection'"></h3>
                        <button class="btn-icon" @click="closeObjectionModal()">&times;</button>
                    </div>
                    <div class="modal-body">
                        <div class="form-group">
                            <label>Name</label>
                            <input type="text" x-model="objectionForm.name"
                                   placeholder="e.g., Vague and Ambiguous"
                                   class="form-input">
                        </div>
                        <div class="form-group">
                            <label>Short Name (for UI display)</label>
                            <input type="text" x-model="objectionForm.short_name"
                                   placeholder="e.g., Vague"
                                   class="form-input">
                        </div>
                        <div class="form-group">
                            <label>Formal Language</label>
                            <textarea x-model="objectionForm.formal_language" rows="3"
                                      placeholder="The formal objection text used in the response document..."
                                      class="form-input"></textarea>
                        </div>
                        <div class="form-group">
                            <label>Argument Template (optional)</label>
                            <textarea x-model="objectionForm.argument_template" rows="3"
                                      placeholder="A template argument supporting this objection..."
                                      class="form-input"></textarea>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button x-show="editingObjection" class="btn btn-danger" style="margin-right: auto;" @click="confirmDeleteObjection(editingObjection)">Delete</button>
                        <button class="btn btn-secondary" @click="closeObjectionModal()">Cancel</button>
                        <button class="btn btn-primary" @click="saveObjection()" :disabled="savingObjection">
                            <span x-show="!savingObjection" x-text="editingObjection ? 'Save Changes' : 'Add Objection'"></span>
                            <span x-show="savingObjection" class="loading"><span class="spinner"></span> Saving...</span>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Delete Confirmation Modal -->
            <div x-show="deletingObjection" class="modal-overlay" @click.self="deletingObjection = null">
                <div class="modal" style="max-width: 400px;">
                    <div class="modal-header">
                        <h3>Delete Objection</h3>
                        <button class="btn-icon" @click="deletingObjection = null">&times;</button>
                    </div>
                    <div class="modal-body">
                        <p>Are you sure you want to delete "<strong x-text="deletingObjection?.name"></strong>"?</p>
                        <p style="color: var(--gray-600); font-size: 0.875rem; margin-top: 0.5rem;">This action cannot be undone.</p>
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-secondary" @click="deletingObjection = null">Cancel</button>
                        <button class="btn btn-danger" @click="deleteObjection()">Delete</button>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        function app() {
            return {
                // Page navigation
                currentPage: 'home',

                // RFP Tool state
                currentStep: 1,
                rfpHelpDismissed: false,
                isDragging: false,
                uploading: false,
                uploadProgress: { progress: 0, message: '' },
                analyzing: false,
                analysisProgress: { progress: 0, message: '', completedChunks: 0, totalChunks: 0 },
                generating: false,
                error: null,

                session: {
                    id: null,
                    requests: [],
                    documents: [],
                    analysis_complete: false
                },

                objections: [],

                // Document Generator state
                motionDragging: false,
                motionUploading: false,
                motionGenerating: false,
                motionError: null,
                motionSessionId: null,
                motionFilename: null,
                motionTemplateVars: {},
                documentTitle: '',
                suggestingTitle: false,
                // Inline editing state
                editingField: null,
                editingValue: '',
                inlineEditError: null,
                // Validation state
                fieldErrors: {},

                // Objections Management state
                managedObjections: [],
                objectionError: null,
                showAddObjection: false,
                editingObjection: null,
                deletingObjection: null,
                savingObjection: false,
                objectionForm: {
                    name: '',
                    short_name: '',
                    formal_language: '',
                    argument_template: ''
                },

                // Users state
                users: [],
                currentUser: null,
                showUserDropdown: false,
                managedUsers: [],
                userError: null,
                showAddUser: false,
                editingUser: null,
                deletingUser: null,
                savingUser: false,
                userIcons: ['üë§', 'üë®‚Äçüíº', 'üë©‚Äçüíº', 'üë®‚Äç‚öñÔ∏è', 'üë©‚Äç‚öñÔ∏è', 'üßë‚Äçüíº', '‚öñÔ∏è', 'üìã'],
                userForm: {
                    name: '',
                    bar_number: '',
                    email: '',
                    icon: 'üë§'
                },

                // Templates state
                templates: [],
                templateTypes: [],
                templatesLoading: false,
                templatesError: null,
                deletingTemplate: null,
                templateUploadType: 'rfp',
                templateDragStates: {},  // { type: boolean } for drag states
                templateUploadStates: {}, // { type: boolean } for upload states
                showNewCategoryModal: false,
                newCategoryName: '',

                async init() {
                    // Load objection presets
                    try {
                        const data = await API.getObjections();
                        this.objections = data.objections || [];
                    } catch (e) {
                        console.error('Failed to load objections:', e);
                        this.objections = [];
                    }

                    // Load users
                    try {
                        const data = await API.getUsers();
                        this.users = data.users || [];
                        // Restore current user from localStorage
                        const savedUserId = localStorage.getItem('currentUserId');
                        if (savedUserId) {
                            this.currentUser = this.users.find(u => u.id == savedUserId) || null;
                        }
                    } catch (e) {
                        console.error('Failed to load users:', e);
                        this.users = [];
                    }

                    // Handle hash-based routing
                    this.handleHashChange();
                    window.addEventListener('hashchange', () => this.handleHashChange());
                },

                // Hash routing
                handleHashChange() {
                    const hash = window.location.hash.slice(1); // Remove #
                    const pageMap = {
                        'home': 'home',
                        'rfp': 'rfp',
                        'motion-opposition': 'motion_opposition',
                        'templates': 'templates',
                        'objections': 'objections',
                        'users': 'users'
                    };

                    if (hash && pageMap[hash]) {
                        this.navigateTo(pageMap[hash], false);
                    } else if (!hash) {
                        // Default to home if no hash
                        this.currentPage = 'home';
                    }
                },

                navigateTo(page, updateHash = true) {
                    this.currentPage = page;

                    // Update URL hash
                    if (updateHash) {
                        const hashMap = {
                            'home': 'home',
                            'rfp': 'rfp',
                            'motion_opposition': 'motion-opposition',
                            'templates': 'templates',
                            'objections': 'objections',
                            'users': 'users'
                        };
                        window.location.hash = hashMap[page] || page;
                    }

                    // Load page-specific data
                    if (page === 'objections') {
                        this.loadManagedObjections();
                    } else if (page === 'users') {
                        this.loadManagedUsers();
                    } else if (page === 'templates') {
                        this.loadTemplates();
                    }
                },

                goToStep(step) {
                    this.error = null;
                    this.currentStep = step;
                },

                async handleRFPDrop(event) {
                    this.isDragging = false;
                    const files = event.dataTransfer.files;
                    if (files.length > 0) {
                        const file = files[0];
                        const isPdf = file.type === 'application/pdf' ||
                                      file.name.toLowerCase().endsWith('.pdf');
                        if (isPdf) {
                            await this.uploadRFP(file);
                        } else {
                            this.error = 'Please upload a PDF file';
                        }
                    }
                },

                async handleRFPSelect(event) {
                    const files = event.target.files;
                    if (files.length > 0) {
                        await this.uploadRFP(files[0]);
                    }
                },

                async uploadRFP(file) {
                    this.uploading = true;
                    this.error = null;
                    this.uploadProgress = { progress: 0, message: 'Uploading PDF...' };

                    try {
                        // Progress callback for polling
                        const onProgress = (progress) => {
                            this.uploadProgress = {
                                progress: progress.progress || 0,
                                message: progress.message || 'Processing...'
                            };
                        };

                        const data = await API.uploadRFP(file, this.session.id, onProgress);
                        this.session.id = data.session_id;
                        this.session.requests = data.requests.map(r => ({
                            ...r,
                            selected_objections: r.suggested_objections || [],
                            selected_documents: r.suggested_documents || [],
                            objection_reasoning: r.objection_reasoning || {}
                        }));
                    } catch (e) {
                        this.error = e.message;
                    } finally {
                        this.uploading = false;
                        this.uploadProgress = { progress: 0, message: '' };
                    }
                },

                async handleDocsDrop(event) {
                    this.isDragging = false;
                    const files = Array.from(event.dataTransfer.files);
                    await this.uploadDocuments(files);
                },

                async handleDocsSelect(event) {
                    const files = Array.from(event.target.files);
                    await this.uploadDocuments(files);
                },

                async uploadDocuments(files) {
                    this.error = null;

                    try {
                        const data = await API.uploadDocuments(this.session.id, files);
                        this.session.documents = [...this.session.documents, ...data.documents];
                    } catch (e) {
                        this.error = e.message;
                    }
                },

                async updateDocMeta(doc) {
                    try {
                        await API.updateDocument(this.session.id, doc.id, {
                            filename: doc.filename,
                            bates_start: doc.bates_start,
                            bates_end: doc.bates_end,
                            description: doc.description
                        });
                    } catch (e) {
                        console.error('Failed to update document:', e);
                    }
                },

                async updateRequest(request) {
                    try {
                        await API.updateRequest(this.session.id, request.id, {
                            number: request.number,
                            text: request.text
                        });
                    } catch (e) {
                        console.error('Failed to update request:', e);
                    }
                },

                removeRequest(index) {
                    this.session.requests.splice(index, 1);
                },

                addRequest() {
                    const maxId = Math.max(0, ...this.session.requests.map(r => r.id));
                    const maxNum = Math.max(0, ...this.session.requests.map(r => parseInt(r.number) || 0));
                    this.session.requests.push({
                        id: maxId + 1,
                        number: String(maxNum + 1),
                        text: '',
                        raw_text: '',
                        suggested_objections: [],
                        suggested_documents: [],
                        selected_objections: [],
                        selected_documents: [],
                        objection_reasoning: {},
                        ai_notes: '',
                        user_notes: '',
                        include_in_response: true
                    });
                },

                async saveRequestsAndContinue() {
                    this.error = null;
                    try {
                        // Save all requests via bulk update
                        const updates = {};
                        this.session.requests.forEach(r => {
                            updates[r.id] = {
                                number: r.number,
                                text: r.text
                            };
                        });
                        await API.bulkUpdateRequests(this.session.id, updates);
                        this.goToStep(2);
                    } catch (e) {
                        this.error = e.message;
                    }
                },

                async removeDocument(docId) {
                    try {
                        await API.deleteDocument(this.session.id, docId);
                        this.session.documents = this.session.documents.filter(d => d.id !== docId);
                        // Remove from selected_documents in all requests
                        this.session.requests.forEach(r => {
                            r.selected_documents = r.selected_documents.filter(id => id !== docId);
                        });
                    } catch (e) {
                        this.error = e.message;
                    }
                },

                async runAnalysis() {
                    this.analyzing = true;
                    this.error = null;
                    this.analysisProgress = { progress: 0, message: 'Saving requests...', completedChunks: 0, totalChunks: 0 };

                    try {
                        // Sync requests to server before analysis (handles adds/removes/edits)
                        await API.syncRequests(this.session.id, this.session.requests);

                        // Progress callback to update UI
                        const onProgress = (progress) => {
                            this.analysisProgress = {
                                progress: progress.progress || 0,
                                message: progress.message || 'Analyzing...',
                                completedChunks: progress.completedChunks || 0,
                                totalChunks: progress.totalChunks || 0
                            };
                        };

                        const data = await API.runAnalysis(this.session.id, onProgress);

                        // Update requests with suggestions
                        if (data.suggestions) {
                            this.session.requests.forEach(r => {
                                const suggestion = data.suggestions[r.number] || data.suggestions[r.id];
                                if (suggestion) {
                                    r.suggested_objections = suggestion.objections || [];
                                    r.suggested_documents = suggestion.documents || [];
                                    r.objection_reasoning = suggestion.objection_reasoning || {};
                                    r.ai_notes = suggestion.notes || '';
                                    // Pre-fill selections with suggestions
                                    r.selected_objections = [...r.suggested_objections];
                                    r.selected_documents = [...r.suggested_documents];
                                }
                            });
                        }

                        this.session.analysis_complete = true;
                        this.goToStep(3);
                    } catch (e) {
                        this.error = e.message;
                        // Still go to step 3 even if analysis fails
                        this.goToStep(3);
                    } finally {
                        this.analyzing = false;
                        this.analysisProgress = { progress: 0, message: '', completedChunks: 0, totalChunks: 0 };
                    }
                },

                toggleObjection(request, objId) {
                    const idx = request.selected_objections.indexOf(objId);
                    if (idx >= 0) {
                        request.selected_objections.splice(idx, 1);
                    } else {
                        request.selected_objections.push(objId);
                    }
                },

                toggleDocument(request, docId) {
                    const idx = request.selected_documents.indexOf(docId);
                    if (idx >= 0) {
                        request.selected_documents.splice(idx, 1);
                    } else {
                        request.selected_documents.push(docId);
                    }
                },

                async saveAndContinue() {
                    this.error = null;

                    try {
                        const updates = {};
                        this.session.requests.forEach(r => {
                            updates[r.id] = {
                                selected_objections: r.selected_objections,
                                selected_documents: r.selected_documents,
                                user_notes: r.user_notes,
                                include_in_response: r.include_in_response
                            };
                        });

                        await API.bulkUpdateRequests(this.session.id, updates);
                        this.goToStep(4);
                    } catch (e) {
                        this.error = e.message;
                    }
                },

                async generateDocument() {
                    this.generating = true;
                    this.error = null;

                    try {
                        // Pass current user info for template variables
                        const associateInfo = this.currentUser ? {
                            associate_name: this.currentUser.name,
                            associate_bar: this.currentUser.bar_number,
                            associate_email: this.currentUser.email
                        } : {};

                        const { blob, filename } = await API.generateResponse(this.session.id, associateInfo);

                        // Download the file
                        const url = window.URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = filename;
                        document.body.appendChild(a);
                        a.click();
                        document.body.removeChild(a);
                        window.URL.revokeObjectURL(url);
                    } catch (e) {
                        this.error = e.message;
                    } finally {
                        this.generating = false;
                    }
                },

                startOver() {
                    this.session = {
                        id: null,
                        requests: [],
                        documents: [],
                        analysis_complete: false
                    };
                    this.currentStep = 1;
                    this.error = null;
                },

                // Document Generator methods
                async initDocGenerator() {
                    // Create a blank session if we don't have one
                    if (!this.motionSessionId) {
                        try {
                            const data = await API.createDocSession();
                            this.motionSessionId = data.session_id;
                            this.motionTemplateVars = data.template_vars;
                        } catch (e) {
                            this.motionError = 'Failed to initialize session: ' + e.message;
                        }
                    }
                },

                async handleMotionDrop(event) {
                    this.motionDragging = false;
                    const files = event.dataTransfer.files;
                    if (files.length > 0) {
                        const file = files[0];
                        const isPdf = file.type === 'application/pdf' ||
                                      file.name.toLowerCase().endsWith('.pdf');
                        if (isPdf) {
                            await this.uploadMotion(file);
                        } else {
                            this.motionError = 'Please upload a PDF file';
                        }
                    }
                },

                async handleMotionSelect(event) {
                    const files = event.target.files;
                    if (files.length > 0) {
                        await this.uploadMotion(files[0]);
                    }
                    // Reset the input so the same file can be selected again
                    event.target.value = '';
                },

                async uploadMotion(file) {
                    this.motionUploading = true;
                    this.motionError = null;

                    try {
                        const data = await API.uploadMotion(file);
                        this.motionSessionId = data.session_id;
                        this.motionFilename = data.filename;
                        this.motionTemplateVars = data.template_vars;
                        this.documentTitle = ''; // Clear document title, user will fill it
                    } catch (e) {
                        this.motionError = e.message;
                    } finally {
                        this.motionUploading = false;
                    }
                },

                async clearMotion() {
                    this.motionSessionId = null;
                    this.motionFilename = null;
                    this.motionTemplateVars = {};
                    this.documentTitle = '';
                    this.motionError = null;
                    this.editingField = null;
                    this.editingValue = '';
                    this.inlineEditError = null;
                    this.fieldErrors = {};
                    // Create a fresh session
                    await this.initDocGenerator();
                },

                canGenerateDocument() {
                    const v = this.motionTemplateVars;
                    // Check required fields are present
                    const hasRequired = v.court_name && v.case_number && v.plaintiff_caption &&
                                       v.defendant_caption && v.judge_name && this.documentTitle;
                    // Check no validation errors
                    const hasNoErrors = Object.keys(this.fieldErrors).length === 0;
                    return hasRequired && hasNoErrors;
                },

                getMissingRequiredFields() {
                    const v = this.motionTemplateVars;
                    const missing = [];
                    if (!v.court_name) missing.push('Court');
                    if (!v.case_number) missing.push('Case Number');
                    if (!v.plaintiff_caption) missing.push('Plaintiff Caption');
                    if (!v.defendant_caption) missing.push('Defendant Caption');
                    if (!v.judge_name) missing.push('Judge');
                    if (!this.documentTitle) missing.push('Document Title');
                    // Also include validation errors
                    for (const [field, error] of Object.entries(this.fieldErrors)) {
                        const fieldLabels = {
                            court_name: 'Court',
                            case_number: 'Case Number',
                            plaintiff_caption: 'Plaintiff',
                            defendant_caption: 'Defendant',
                            judge_name: 'Judge',
                            motion_title: 'Motion Title',
                            documentTitle: 'Document Title'
                        };
                        const label = fieldLabels[field] || field;
                        if (!missing.includes(label)) {
                            missing.push(`${label} (${error})`);
                        }
                    }
                    return missing;
                },

                async suggestDocumentTitle() {
                    if (!this.motionSessionId) return;

                    this.suggestingTitle = true;
                    try {
                        const data = await API.suggestDocTitle(this.motionSessionId);
                        this.documentTitle = data.suggested_title;
                    } catch (e) {
                        this.motionError = 'Failed to suggest title: ' + e.message;
                    } finally {
                        this.suggestingTitle = false;
                    }
                },

                // Save field on blur
                async saveField(field) {
                    // Run validation
                    this.validateField(field);

                    if (!this.motionSessionId) return;

                    try {
                        await API.updateMotionSession(this.motionSessionId, this.motionTemplateVars);
                    } catch (e) {
                        this.motionError = 'Failed to save: ' + e.message;
                    }
                },

                validateField(field) {
                    const v = this.motionTemplateVars;
                    const value = (field === 'documentTitle') ? this.documentTitle : (v[field] || '');

                    // Clear previous error
                    delete this.fieldErrors[field];

                    // Required field check (all except mag_judge_name, motion_title, and hearing fields)
                    const optionalFields = ['mag_judge_name', 'motion_title', 'hearing_date', 'hearing_time', 'hearing_location'];
                    const requiredFields = ['court_name', 'case_number', 'plaintiff_caption', 'defendant_caption', 'judge_name', 'documentTitle'];

                    if (requiredFields.includes(field) && !value.trim()) {
                        this.fieldErrors[field] = 'Required';
                        return false;
                    }

                    // Case number must start with a number
                    if (field === 'case_number' && value.trim() && !/^\d/.test(value.trim())) {
                        this.fieldErrors[field] = 'Must start with a number';
                        return false;
                    }

                    // Plaintiff/Defendant must end with letter or number
                    if ((field === 'plaintiff_caption' || field === 'defendant_caption') && value.trim()) {
                        const trimmed = value.trim();
                        const lastChar = trimmed[trimmed.length - 1];
                        if (/[,;]/.test(lastChar)) {
                            this.fieldErrors[field] = 'Cannot end with a comma or semicolon';
                            return false;
                        }
                    }

                    return true;
                },

                validateAllFields() {
                    const fields = ['court_name', 'case_number', 'plaintiff_caption', 'defendant_caption', 'judge_name', 'documentTitle'];
                    let allValid = true;
                    for (const field of fields) {
                        if (!this.validateField(field)) {
                            allValid = false;
                        }
                    }
                    return allValid;
                },

                hasFieldError(field) {
                    return !!this.fieldErrors[field];
                },

                // Inline editing methods (legacy, keeping for compatibility)
                startInlineEdit(field, currentValue) {
                    this.editingField = field;
                    this.editingValue = currentValue || '';
                    this.inlineEditError = null;
                },

                cancelInlineEdit() {
                    this.editingField = null;
                    this.editingValue = '';
                    this.inlineEditError = null;
                },

                async saveInlineEdit(field) {
                    const requiredFields = ['court_name', 'case_number', 'plaintiff_caption', 'defendant_caption'];
                    const labels = {
                        court_name: 'Court',
                        case_number: 'Case Number',
                        plaintiff_caption: 'Plaintiff Caption',
                        defendant_caption: 'Defendant Caption'
                    };

                    // Validate required fields
                    if (requiredFields.includes(field) && !this.editingValue.trim()) {
                        this.inlineEditError = `${labels[field]} is required`;
                        return;
                    }

                    this.inlineEditError = null;

                    try {
                        // Update local state
                        const updatedVars = { ...this.motionTemplateVars };
                        updatedVars[field] = this.editingValue;

                        // Sync multiple_plt with multiple_plaintiffs
                        if (field === 'multiple_plaintiffs') {
                            updatedVars.multiple_plt = updatedVars.multiple_plaintiffs;
                        }

                        // Save to server
                        await API.updateMotionSession(this.motionSessionId, updatedVars);
                        this.motionTemplateVars = updatedVars;
                        this.cancelInlineEdit();
                    } catch (e) {
                        this.inlineEditError = e.message;
                    }
                },

                async toggleBooleanField(field) {
                    this.inlineEditError = null;

                    try {
                        const updatedVars = { ...this.motionTemplateVars };
                        updatedVars[field] = !updatedVars[field];

                        // Sync multiple_plt with multiple_plaintiffs
                        if (field === 'multiple_plaintiffs') {
                            updatedVars.multiple_plt = updatedVars.multiple_plaintiffs;
                        }

                        await API.updateMotionSession(this.motionSessionId, updatedVars);
                        this.motionTemplateVars = updatedVars;
                    } catch (e) {
                        this.inlineEditError = e.message;
                    }
                },

                async generateMotionDocument() {
                    if (!this.currentUser) {
                        this.motionError = 'Please sign in to generate documents';
                        return;
                    }

                    // Run validation on all fields
                    if (!this.validateAllFields()) {
                        this.motionError = 'Please fix the validation errors above';
                        return;
                    }

                    this.motionGenerating = true;
                    this.motionError = null;

                    try {
                        const { blob, filename } = await API.generateDocument(this.motionSessionId, this.documentTitle, {
                            associate_name: this.currentUser.name,
                            associate_bar: this.currentUser.bar_number,
                            associate_email: this.currentUser.email
                        });

                        // Download the file
                        const url = window.URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = filename;
                        document.body.appendChild(a);
                        a.click();
                        document.body.removeChild(a);
                        window.URL.revokeObjectURL(url);
                    } catch (e) {
                        this.motionError = e.message;
                    } finally {
                        this.motionGenerating = false;
                    }
                },

                // Page navigation (legacy - use navigateTo instead)
                switchPage(page) {
                    this.navigateTo(page);
                },

                // Objections Management methods
                async loadManagedObjections() {
                    this.objectionError = null;
                    try {
                        const data = await API.getObjections();
                        this.managedObjections = data.objections || [];
                    } catch (e) {
                        this.objectionError = e.message;
                    }
                },

                editObjection(obj) {
                    this.editingObjection = obj;
                    this.objectionForm = {
                        name: obj.name,
                        short_name: obj.short_name,
                        formal_language: obj.formal_language,
                        argument_template: obj.argument_template || ''
                    };
                },

                confirmDeleteObjection(obj) {
                    this.deletingObjection = obj;
                },

                closeObjectionModal() {
                    this.showAddObjection = false;
                    this.editingObjection = null;
                    this.objectionForm = {
                        name: '',
                        short_name: '',
                        formal_language: '',
                        argument_template: ''
                    };
                },

                // Generate a unique ID from short_name
                generateUniqueId(shortName) {
                    // Slugify: lowercase, replace spaces with underscores, remove special chars
                    let baseId = shortName
                        .toLowerCase()
                        .replace(/\s+/g, '_')
                        .replace(/[^a-z0-9_]/g, '');

                    // Check for duplicates
                    const existingIds = this.managedObjections.map(o => o.id);
                    let uniqueId = baseId;
                    let counter = 1;

                    while (existingIds.includes(uniqueId)) {
                        uniqueId = `${baseId}_${counter}`;
                        counter++;
                    }

                    return uniqueId;
                },

                async saveObjection() {
                    this.objectionError = null;
                    this.savingObjection = true;

                    try {
                        if (this.editingObjection) {
                            // Update existing
                            await API.updateObjection(this.editingObjection.id, {
                                name: this.objectionForm.name,
                                short_name: this.objectionForm.short_name,
                                formal_language: this.objectionForm.formal_language,
                                argument_template: this.objectionForm.argument_template
                            });
                        } else {
                            // Create new - generate ID from short_name
                            const newId = this.generateUniqueId(this.objectionForm.short_name);
                            await API.createObjection({
                                id: newId,
                                name: this.objectionForm.name,
                                short_name: this.objectionForm.short_name,
                                formal_language: this.objectionForm.formal_language,
                                argument_template: this.objectionForm.argument_template
                            });
                        }

                        await this.loadManagedObjections();
                        // Also refresh the objections used in RFP tool
                        const data = await API.getObjections();
                        this.objections = data.objections || [];

                        this.closeObjectionModal();
                    } catch (e) {
                        this.objectionError = e.message;
                    } finally {
                        this.savingObjection = false;
                    }
                },

                async deleteObjection() {
                    if (!this.deletingObjection) return;

                    this.objectionError = null;

                    try {
                        await API.deleteObjection(this.deletingObjection.id);
                        await this.loadManagedObjections();
                        // Also refresh the objections used in RFP tool
                        const data = await API.getObjections();
                        this.objections = data.objections || [];

                        this.deletingObjection = null;
                    } catch (e) {
                        this.objectionError = e.message;
                    }
                },

                // User selection methods
                selectUser(user) {
                    this.currentUser = user;
                    this.showUserDropdown = false;
                    localStorage.setItem('currentUserId', user.id);
                },

                signOut() {
                    this.currentUser = null;
                    this.showUserDropdown = false;
                    localStorage.removeItem('currentUserId');
                },

                // Users Management methods
                async loadManagedUsers() {
                    this.userError = null;
                    try {
                        const data = await API.getUsers();
                        this.managedUsers = data.users || [];
                    } catch (e) {
                        this.userError = e.message;
                    }
                },

                editUser(user) {
                    this.editingUser = user;
                    this.userForm = {
                        name: user.name,
                        bar_number: user.bar_number,
                        email: user.email,
                        icon: user.icon || 'üë§'
                    };
                },

                confirmDeleteUser(user) {
                    this.deletingUser = user;
                },

                closeUserModal() {
                    this.showAddUser = false;
                    this.editingUser = null;
                    this.userForm = {
                        name: '',
                        bar_number: '',
                        email: '',
                        icon: 'üë§'
                    };
                },

                async saveUser() {
                    this.userError = null;
                    this.savingUser = true;

                    try {
                        if (this.editingUser) {
                            // Update existing
                            await API.updateUser(this.editingUser.id, {
                                name: this.userForm.name,
                                bar_number: this.userForm.bar_number,
                                email: this.userForm.email,
                                icon: this.userForm.icon
                            });
                        } else {
                            // Create new
                            await API.createUser({
                                name: this.userForm.name,
                                bar_number: this.userForm.bar_number,
                                email: this.userForm.email,
                                icon: this.userForm.icon
                            });
                        }

                        await this.loadManagedUsers();
                        // Also refresh the users dropdown
                        const data = await API.getUsers();
                        this.users = data.users || [];

                        this.closeUserModal();
                    } catch (e) {
                        this.userError = e.message;
                    } finally {
                        this.savingUser = false;
                    }
                },

                async deleteUser() {
                    if (!this.deletingUser) return;

                    this.userError = null;

                    try {
                        await API.deleteUser(this.deletingUser.id);
                        await this.loadManagedUsers();
                        // Also refresh the users dropdown
                        const data = await API.getUsers();
                        this.users = data.users || [];

                        // If deleted user was current user, sign out
                        if (this.currentUser?.id === this.deletingUser.id) {
                            this.signOut();
                        }

                        this.deletingUser = null;
                    } catch (e) {
                        this.userError = e.message;
                    }
                },

                // Template Management methods
                async loadTemplates() {
                    this.templatesLoading = true;
                    this.templatesError = null;
                    try {
                        // Load templates and types in parallel
                        const [templatesData, typesData] = await Promise.all([
                            API.getTemplates(),
                            API.getTemplateTypes()
                        ]);
                        this.templates = templatesData.templates || [];
                        this.templateTypes = typesData.types || ['rfp', 'opposition'];
                    } catch (e) {
                        this.templatesError = e.message;
                    } finally {
                        this.templatesLoading = false;
                    }
                },

                async handleTemplateFileSelect(event) {
                    const files = event.target.files;
                    if (files.length === 0) return;

                    const file = files[0];
                    event.target.value = ''; // Reset input

                    await this.uploadTemplateFile(file, this.templateUploadType);
                },

                async handleTemplateDropForType(event, type) {
                    // Reset all drag states
                    this.templateDragStates = {};

                    const files = event.dataTransfer.files;
                    if (files.length === 0) return;

                    const file = files[0];
                    await this.uploadTemplateFile(file, type);
                },

                async uploadTemplateFile(file, type) {
                    if (!file.name.toLowerCase().endsWith('.docx')) {
                        this.templatesError = 'Please upload a .docx file';
                        return;
                    }

                    // Set uploading state for the correct section
                    this.templateUploadStates[type] = true;
                    this.templatesError = null;

                    try {
                        await API.uploadTemplate(file, this.currentUser.id, type);
                        await this.loadTemplates();
                    } catch (e) {
                        this.templatesError = e.message;
                    } finally {
                        this.templateUploadStates[type] = false;
                    }
                },

                confirmDeleteTemplate(template) {
                    this.deletingTemplate = template;
                },

                async deleteTemplate() {
                    if (!this.deletingTemplate) return;

                    this.templatesError = null;

                    try {
                        await API.deleteTemplate(this.deletingTemplate.id);
                        await this.loadTemplates();
                        this.deletingTemplate = null;
                    } catch (e) {
                        this.templatesError = e.message;
                    }
                },

                async downloadTemplate(template) {
                    try {
                        const { blob, filename } = await API.downloadTemplate(template.id);
                        const url = window.URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = filename || template.name;
                        document.body.appendChild(a);
                        a.click();
                        document.body.removeChild(a);
                        window.URL.revokeObjectURL(url);
                    } catch (e) {
                        this.templatesError = e.message;
                    }
                },

                // Category helper methods
                getCategoryIcon(type) {
                    const icons = {
                        'rfp': 'üìã',
                        'opposition': '‚öñÔ∏è',
                        'discovery': 'üîç',
                        'motion': 'üìù',
                        'pleading': 'üìú',
                        'brief': 'üìë'
                    };
                    return icons[type] || 'üìÑ';
                },

                getCategoryColor(type) {
                    const colors = {
                        'rfp': '#dbeafe',
                        'opposition': '#fef3c7',
                        'discovery': '#dcfce7',
                        'motion': '#f3e8ff',
                        'pleading': '#ffe4e6',
                        'brief': '#e0e7ff'
                    };
                    return colors[type] || '#f3f4f6';
                },

                formatCategoryName(type) {
                    // Convert type to display name (e.g., "rfp" -> "RFP", "motion-opposition" -> "Motion Opposition")
                    if (type === 'rfp') return 'RFP Response';
                    if (type === 'opposition') return 'Motion Opposition';
                    return type
                        .split(/[-_]/)
                        .map(word => word.charAt(0).toUpperCase() + word.slice(1))
                        .join(' ');
                },

                createNewCategory() {
                    const categoryName = this.newCategoryName.trim().toLowerCase().replace(/\s+/g, '-');
                    if (!categoryName) return;

                    // Validate category name
                    if (!/^[a-z0-9_-]+$/.test(categoryName)) {
                        this.templatesError = 'Category name can only contain lowercase letters, numbers, hyphens, and underscores';
                        return;
                    }

                    // Check if category already exists
                    if (this.templateTypes.includes(categoryName)) {
                        this.templatesError = 'This category already exists';
                        return;
                    }

                    // Set the type and trigger file upload
                    this.templateUploadType = categoryName;
                    this.showNewCategoryModal = false;
                    this.newCategoryName = '';

                    // Trigger file input
                    this.$refs.templateInput.click();
                },

                formatDate(dateStr) {
                    if (!dateStr) return '';
                    const date = new Date(dateStr);
                    const month = date.getMonth() + 1;
                    const day = date.getDate();
                    let hours = date.getHours();
                    const minutes = date.getMinutes().toString().padStart(2, '0');
                    const ampm = hours >= 12 ? 'pm' : 'am';
                    hours = hours % 12 || 12;
                    return `${month}/${day} ${hours}:${minutes}${ampm}`;
                },

                getInitials(name) {
                    if (!name) return '?';
                    return name.split(/[\s-]+/).map(n => n[0]).join('').toUpperCase();
                }
            };
        }
    </script>
</body>
</html>
