name: Keep Supabase Active

on:
  schedule:
    - cron: '0 12 * * *'  # Daily at noon UTC
  workflow_dispatch:  # Allow manual trigger

permissions:
  issues: write

jobs:
  ping:
    runs-on: ubuntu-latest
    steps:
      - name: Fetch objections from Supabase
        id: ping
        run: |
          echo "::group::Request Details"
          echo "Timestamp: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
          echo "Endpoint: /rest/v1/objections?select=id,name&limit=5"
          echo "::endgroup::"

          response=$(curl -s -w "\n%{http_code}" \
            "${{ secrets.SUPABASE_URL }}/rest/v1/objections?select=id,name&limit=5" \
            -H "apikey: ${{ secrets.SUPABASE_ANON_KEY }}" \
            -H "Authorization: Bearer ${{ secrets.SUPABASE_ANON_KEY }}")
          http_code=$(echo "$response" | tail -n1)
          body=$(echo "$response" | sed '$d')

          echo "::group::Response"
          echo "HTTP Status: $http_code"
          echo "Body: $body"
          echo "::endgroup::"

          if [ "$http_code" -ne 200 ]; then
            echo "::error::Supabase returned HTTP $http_code"
            echo "status=failed" >> $GITHUB_OUTPUT
            exit 1
          fi

          if [ "$body" = "[]" ] || [ -z "$body" ]; then
            echo "::error::No objections returned from Supabase"
            echo "status=failed" >> $GITHUB_OUTPUT
            exit 1
          fi

          # Count objections returned
          count=$(echo "$body" | grep -o '"id"' | wc -l)
          echo "::notice::Successfully fetched $count objection(s) from Supabase"
          echo "status=success" >> $GITHUB_OUTPUT

      - name: Create issue on failure
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'Supabase ping failed',
              body: `The daily Supabase keep-alive ping failed.\n\nCheck the [workflow run](${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}) for details.`,
              labels: ['bug']
            })
