name: Keep Supabase Active

on:
  schedule:
    - cron: '0 12 * * *'  # Daily at noon UTC
  workflow_dispatch:  # Allow manual trigger

jobs:
  ping:
    runs-on: ubuntu-latest
    steps:
      - name: Fetch objections from Supabase
        id: ping
        run: |
          response=$(curl -s -w "\n%{http_code}" \
            "${{ secrets.SUPABASE_URL }}/rest/v1/objections?select=id&limit=1" \
            -H "apikey: ${{ secrets.SUPABASE_ANON_KEY }}" \
            -H "Authorization: Bearer ${{ secrets.SUPABASE_ANON_KEY }}")
          http_code=$(echo "$response" | tail -n1)
          body=$(echo "$response" | sed '$d')
          echo "Response code: $http_code"
          echo "Body: $body"
          if [ "$http_code" -ne 200 ]; then
            echo "status=failed" >> $GITHUB_OUTPUT
            echo "error=HTTP $http_code" >> $GITHUB_OUTPUT
            exit 1
          fi
          if [ "$body" = "[]" ] || [ -z "$body" ]; then
            echo "status=failed" >> $GITHUB_OUTPUT
            echo "error=No objections returned" >> $GITHUB_OUTPUT
            exit 1
          fi
          echo "status=success" >> $GITHUB_OUTPUT
          echo "Successfully pinged Supabase"

      - name: Create issue on failure
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'Supabase ping failed',
              body: `The daily Supabase keep-alive ping failed.\n\nCheck the [workflow run](${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}) for details.`,
              labels: ['bug']
            })
